<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle Producto | Anmago Store</title>
  <meta name="description" content="Descubre este producto exclusivo en Anmago Store. Calidad garantizada y los mejores precios.">
  <!-- Preconexiones optimizadas -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://ik.imagekit.io">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <!-- PWA y favicon -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.jpg" type="image/x-icon" />

  <!-- Bootstrap e iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

  <!-- CSS optimizado -->
  <link rel="stylesheet" href="ESTILO.CSS?v=20251115" />
  
  </head>
<body class="bg-light">
  <!-- Scripts optimizados -->
  <script src="carrito.js?v=20251115"></script>
  <script src="app.js?v=20251115"></script>
 <!-- BUSCADOR EN HEADER -->
  <div class="flex-grow-1 mx-3 position-relative" style="max-width: 500px;">
    <input id="buscador" class="form-control buscador-header" 
           placeholder="Buscar productos..." 
           autocomplete="off">
    <div id="sugerencias" class="sugerencias-container"></div>
  </div>
 
  
  <!-- BANNER PROMOCIONAL -->
  <div class="container-fluid banner-promocional py-2">
    <div class="container text-center">
      <small class="fw-bold">‚≠ê Los mejores precios ‚≠ê Calidad garantizada</small>
    </div>
  </div>

  <!-- BOTONES EN LA MISMA L√çNEA - COMPACTO -->
  <div class="container mt-3">
    <div class="row align-items-center">
      <!-- Bot√≥n Volver atr√°s (izquierda) -->
      <div class="col text-start">
        <a href="#" id="btn-volver-atras" class="btn btn-outline-dark btn-sm" onclick="volverAtras()">
          <i class="bi bi-arrow-left"></i> Volver
        </a>
      </div>

      <!-- Bot√≥n Ofertas Especiales (derecha) -->
      <div class="col text-end">
        <a href="PROMOS.HTML" class="btn btn-warning fw-bold px-3 py-2 rounded-pill">
          üéÅ Ofertas
        </a>
      </div>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL - DETALLE PRODUCTO -->
  <main class="container mt-4">
    
    <!-- T√çTULO Y PRECIO PARA M√ìVIL (ARRIBA DE TODO) -->
    <div class="d-block d-md-none mb-4">
      <!-- Categor√≠as -->
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb" id="breadcrumb-producto-mobile">
          <li class="breadcrumb-item"><a href="INICIO.HTML">ATR√ÅS</a></li>
          <!-- Categor√≠as se cargan din√°micamente -->
        </ol>
      </nav>

      <!-- Nombre y precio -->
      <h1 id="nombre-producto-mobile" class="h3 fw-bold mb-2"></h1>
      <div class="d-flex align-items-center gap-3 mb-3">
        <span id="precio-actual-mobile" class="h4 fw-bold text-primary mb-0"></span>
        <span id="precio-original-mobile" class="text-muted h5 mb-0 text-decoration-line-through"></span>
        <span id="descuento-mobile" class="badge badge-oferta fs-6"></span>
      </div>
    </div>

    <div class="row">
      <!-- GALER√çA DE IM√ÅGENES CON ZOOM -->
      <div class="col-md-6 mb-4">
        <div class="sticky-top" style="top: 100px;">
          <!-- IMAGEN PRINCIPAL CON ZOOM MEJORADA -->
          <div class="position-relative mb-3">
            <img id="imagen-principal" src="" alt="Producto" 
                 class="card-img-ml shadow img-fluid"
                 style="cursor: zoom-in; max-height: 500px; width: 100%; object-fit: contain; transition: all 0.3s ease; border-radius: 12px;"
                 onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'"
                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''"
                 onclick="ampliarImagen(this.src)"
                 ondblclick="ampliarImagen(this.src)">
            
            <!-- Indicador de zoom -->
            <div class="position-absolute top-0 end-0 m-3">
              <div class="bg-dark bg-opacity-75 rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="bi bi-zoom-in text-white fs-6"></i>
              </div>
            </div>
            
            <!-- Texto ayuda -->
            <div class="position-absolute bottom-0 start-0 end-0 text-center mb-2">
              <small class="badge bg-dark bg-opacity-75 text-white px-3 py-2">
                <i class="bi bi-mouse"></i> Clic para ampliar ‚Ä¢ 
                <i class="bi bi-arrows-fullscreen"></i> Doble clic para zoom m√°ximo
              </small>
            </div>
          </div>
          
          <!-- ALERTA PARA SELECCIONAR IMAGEN -->
          <div id="alerta-seleccion-imagen" class="alert alert-warning mt-3" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i> 
            <strong>¬°Selecciona una imagen!</strong> Por favor elige la variante que deseas.
          </div>
          
          <div class="galeria-miniaturas" id="galeria-miniaturas">
            <!-- Miniaturas se cargan din√°micamente -->
          </div>

          <!-- Badges de estado -->
          <div class="mt-3" id="badges-producto">
            <!-- Badges se cargan din√°micamente -->
          </div>

          <!-- VIDEO DEL PRODUCTO EN DESKTOP (debajo de las im√°genes) -->
          <!-- SOLO SE MUESTRA EN DESKTOP -->
          <div id="video-producto-desktop" class="d-none d-md-block mt-4"></div>
        </div>
      </div>

      <!-- INFORMACI√ìN DEL PRODUCTO -->
      <div class="col-md-6">
        <div class="ps-md-4">
          <!-- T√çTULO Y PRECIO PARA DESKTOP (DENTRO DE LA COLUMNA) -->
          <div class="d-none d-md-block">
            <!-- Categor√≠as -->
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb" id="breadcrumb-producto-desktop">
                <li class="breadcrumb-item"><a href="INICIO.HTML">ATR√ÅS</a></li>
                <!-- Categor√≠as se cargan din√°micamente -->
              </ol>
            </nav>

            <!-- Nombre y precio -->
            <h1 id="nombre-producto-desktop" class="h3 fw-bold mb-2"></h1>
            <div class="d-flex align-items-center gap-3 mb-3">
              <span id="precio-actual-desktop" class="h4 fw-bold text-primary mb-0"></span>
              <span id="precio-original-desktop" class="text-muted h5 mb-0 text-decoration-line-through"></span>
              <span id="descuento-desktop" class="badge badge-oferta fs-6"></span>
            </div>
          </div>

          <!-- VIDEO DEL PRODUCTO EN M√ìVIL (antes de la descripci√≥n) -->
          <!-- SOLO SE MUESTRA EN M√ìVIL -->
          <div id="video-producto-mobile" class="d-block d-md-none mb-4"></div>

          <!-- VARIANTE ACTUAL (se muestra cuando se selecciona imagen) -->
          <div class="mb-3" id="variante-actual-container" style="display: none;">
            <h5 class="fw-bold mb-2">üé® Variante seleccionada</h5>
            <div class="alert alert-info py-2">
              <span id="variante-actual-texto"></span>
            </div>
          </div>
               
          <!-- SELECTOR DE VARIABLES (COLORES/MATERIALES) -->
          <div class="mb-4" id="seccion-variables">
            <!-- Selector de variables se carga din√°micamente -->
          </div>

          <!-- SELECTOR DE TALLAS -->
          <div class="mb-4" id="seccion-tallas">
            <!-- Selector de tallas se carga din√°micamente -->
          </div>

          <!-- Cantidad -->
          <div class="mb-4">
            <h5 class="fw-bold mb-3">üî¢ Cantidad</h5>
            <div class="d-flex align-items-center gap-3">
              <button class="btn btn-outline-secondary" onclick="cambiarCantidad(-1)">-</button>
              <input type="number" id="input-cantidad" class="form-control text-center" value="1" min="1" max="10" style="width: 80px;">
              <button class="btn btn-outline-secondary" onclick="cambiarCantidad(1)">+</button>
            </div>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="d-grid gap-2 d-md-flex mb-4">
            <button id="btn-agregar-carrito" class="btn btn-agregar-carrito btn-lg flex-fw-bold" onclick="agregarAlCarrito()" disabled>
              <i class="bi bi-cart-plus"></i> Agregar al carrito
            </button>
            <button class="btn btn-gradient btn-lg" onclick="comprarAhora()" disabled>
              <i class="bi bi-lightning"></i> Comprar ahora
            </button>
          </div>

          <!-- Descripci√≥n -->
          <div class="mb-4">
            <h5 class="fw-bold mb-2">üìã Descripci√≥n</h5>
            <p id="descripcion-producto" class="text-muted"></p>
          </div>

          <!-- SERVICIOS (REEMPLAZA ENV√çO GRATIS) -->
          <div class="card border-0 bg-light">
            <div class="card-body">
              <div class="row text-center">
                <div class="col-4">
                  <i class="bi bi-shield-check text-primary fs-4"></i>
                  <div class="small mt-1">Calidad</div>
                </div>
                <div class="col-4">
                  <i class="bi bi-star text-primary fs-4"></i>
                  <div class="small mt-1">Garant√≠a</div>
                </div>
                <div class="col-4">
                  <i class="bi bi-percent text-primary fs-4"></i>
                  <div class="small mt-1">PROMOS</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PRODUCTOS RELACIONADOS -->
    <section class="mt-5 pt-4 border-top">
      <h3 class="h4 fw-bold mb-4">üõçÔ∏è Productos relacionados</h3>
      <div id="productos-relacionados" class="grid-productos-ml">
        <!-- Productos relacionados se cargan din√°micamente -->
        <div class="card-producto-ml skeleton" style="height: 280px;"></div>
        <div class="card-producto-ml skeleton" style="height: 280px;"></div>
        <div class="card-producto-ml skeleton" style="height: 280px;"></div>
        <div class="card-producto-ml skeleton" style="height: 280px;"></div>
      </div>
    </section>
  </main>

  <!-- CARRITO OFFCANVAS -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCarrito">
    <div class="offcanvas-header border-bottom">
      <h4 class="offcanvas-title fw-bold">üõí Tu Carrito</h4>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body" id="carrito-contenido">
      <div class="text-center text-muted py-4">
        <i class="bi bi-bag-x fs-1"></i>
        <p class="mt-2">Tu carrito est√° vac√≠o</p>
      </div>
    </div>
    <div class="offcanvas-footer p-3 border-top">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="fw-bold">Subtotal:</span>
        <span id="subtotal" class="fw-bold fs-5 text-primary">$0</span>
      </div>
      <button class="btn btn-gradient px-4 py-2 rounded-pill fw-bold" onclick="abrirFormularioPedido()">
        ‚ú®Continuar compra‚ú®
      </button>
    </div>
  </div>

  <!-- BOT√ìN CARRITO FLOTANTE -->
  <a href="#" class="btn-carrito-flotante d-none d-md-flex" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
    <i class="bi bi-bag-heart fs-5"></i>
    <span id="contador-carrito" class="contador-carrito">0</span>
  </a>

  <!-- FOOTER -->
  <div id="footer-container" class="mt-5"></div>

  <!-- BARRA INFERIOR MOBILE -->
  <nav class="navbar fixed-bottom bg-white border-top d-md-none py-2">
    <div class="container-fluid">
      <div class="d-flex justify-content-around w-100">
        <a href="INICIO.HTML" class="text-center text-decoration-none text-primary">
          <i class="bi bi-house-fill fs-5"></i>
          <div class="small">Inicio</div>
        </a>
        <a href="PROMOS.HTML" class="text-center text-decoration-none text-dark">
          <i class="bi bi-percent fs-5"></i>
          <div class="small">Ofertas</div>
        </a>
        <a href="#" class="text-center text-decoration-none position-relative"
           data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
          <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
               style="width: 50px; height: 50px; margin-top: -8px;">
            <i class="bi bi-bag-heart fs-5 text-white"></i>
          </div>
          <span id="contador-carrito-mobile" class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill" style="font-size: 0.6rem;">0</span>
          <div class="small mt-1">Carrito</div>
        </a>
        <a href="https://wa.me/573006498710?text=¬°Hola!%20Me%20interesan%20sus%20productos%20de%20Anmago%20Store" 
           class="text-center text-decoration-none text-success"
           target="_blank">
          <i class="bi bi-whatsapp fs-5"></i>
          <div class="small">Chat</div>
        </a>
        <a href="modalformulario.html" class="text-center text-decoration-none text-dark">
          <i class="bi bi-person fs-5"></i>
          <div class="small">Cuenta</div>
        </a>
      </div>
    </div>
  </nav>

  <!-- SISTEMA DE DETALLE PRODUCTO CON DESCUENTOS DIN√ÅMICOS -->
  <script>
    // ========== VARIABLES GLOBALES ==========
    let productoActual = null;
    let varianteSeleccionada = '';
    let variableSeleccionada = '';
    let tallaSeleccionada = '';
    let imagenSeleccionada = '';
    let cantidad = 1;
    let promocionesGlobal = [];
    let imagenesProducto = [];
    let nombresVariantes = [];

    // ========== SISTEMA DE PROMOCIONES DIN√ÅMICAS ==========

    // üéØ Detectar si el producto viene desde promociones
    function vieneDePromociones() {
      const urlParams = new URLSearchParams(window.location.search);
      const origen = urlParams.get('origen');
      return origen === 'promos' || origen === 'home' || window.location.pathname.includes('PROMOS');
    }

    // üéØ Obtener √≠ndice promocional (MISMA FUNCI√ìN EXACTA QUE EN PROMOS.HTML)
    function obtenerIndicePromocional(totalPromos = 0) {
      const ahora = new Date();
      ahora.setMinutes(0, 0, 0); // elimina minutos, segundos y milisegundos

      const inicio = new Date(Date.UTC(2025, 10, 8, 0, 0, 0)); // noviembre = 10, UTC fijo

      const diferenciaHoras = Math.floor((ahora - inicio) / (1000 * 60 * 60));
      const cicloActual = diferenciaHoras % (4 * 365); // 4 ciclos por d√≠a
      const indice = cicloActual * 4; // 4 productos por ciclo

      return totalPromos > 0 ? indice % totalPromos : 0;
    }

    // üîç Verificar si el producto est√° en promoci√≥n actual
    function estaEnPromocionActual(productoId) {
      if (!promocionesGlobal || !Array.isArray(promocionesGlobal)) {
        console.log('‚ùå promocionesGlobal no est√° disponible');
        return false;
      }
      
      const totalPromos = promocionesGlobal.length;
      
      if (totalPromos === 0) {
        console.log('‚ùå No hay promociones disponibles');
        return false;
      }
      
      // ‚úÖ CORREGIDO: usar la misma l√≥gica que PROMOS.HTML
      const indiceActual = obtenerIndicePromocional(totalPromos);
      
      // Obtener el bloque actual de 4 promociones
      const bloqueActual = promocionesGlobal.slice(indiceActual, indiceActual + 4);
      
      // Verificar si el producto est√° en el bloque actual
      const estaEnPromo = bloqueActual.some(promo => promo.id === productoId);
      
      console.log('üî• Verificaci√≥n promoci√≥n:', {
        productoId,
        estaEnPromo,
        bloqueActual: bloqueActual.map(p => ({id: p.id, nombre: p.producto})),
        indiceActual,
        totalPromos
      });
      
      return estaEnPromo;
    }

    // üí∞ Calcular precio con descuento si aplica - VERSI√ìN MEJORADA
    function calcularPrecioConDescuento(producto) {
      const precioBase = producto.precio || 0;
      
      // ‚úÖ SI VIENE DESDE PROMOCIONES, APLICAR 10% DE DESCUENTO SIEMPRE
      if (vieneDePromociones()) {
        const precioDescuento = Math.round(precioBase * 0.9);
        console.log('üí∞ Aplicando descuento desde promociones:', { 
          producto: producto.producto, 
          precioBase, 
          precioDescuento,
          origen: 'promos'
        });
        return precioDescuento;
      }
      
      // Si no viene de promociones, verificar si est√° en el bloque actual
      if (estaEnPromocionActual(producto.id)) {
        const precioDescuento = Math.round(precioBase * 0.9);
        console.log('üí∞ Aplicando descuento por bloque actual:', { 
          producto: producto.producto, 
          precioBase, 
          precioDescuento,
          origen: 'bloque'
        });
        return precioDescuento;
      }
      
      console.log('üí∞ Precio normal (sin promoci√≥n):', { 
        producto: producto.producto, 
        precioBase,
        origen: 'normal'
      });
      
      // Si no est√° en promoci√≥n, usar precio normal
      return precioBase;
    }

    // ========== SISTEMA DE NAVEGACI√ìN CON ESTADO ==========

    // üîÑ FUNCI√ìN PARA VOLVER ATR√ÅS CON ESTADO
    function volverAtras() {
        console.log('üîô Ejecutando volverAtras...');
        
        const estadoGuardado = localStorage.getItem('navegacionAnmago');
        
        if (estadoGuardado) {
            try {
                const estado = JSON.parse(estadoGuardado);
                const ahora = Date.now();
                const tiempoTranscurrido = ahora - estado.timestamp;
                
                // Solo restaurar si ha pasado menos de 30 minutos
                if (tiempoTranscurrido < 30 * 60 * 1000) {
                    console.log('üìç Estado de navegaci√≥n encontrado:', estado);
                    
                    // Construir URL de retorno basada en el estado guardado
                    let urlRetorno = 'INICIO.HTML';
                    
                    switch (estado.vistaAnterior) {
                        case 'productos':
                            if (estado.tipo && estado.subtipo && estado.categoria) {
                                urlRetorno = `INICIO.HTML?vista=productos&tipo=${encodeURIComponent(estado.tipo)}&subtipo=${encodeURIComponent(estado.subtipo)}&categoria=${encodeURIComponent(estado.categoria)}`;
                                console.log('üéØ Redirigiendo a vista productos:', urlRetorno);
                            }
                            break;
                        case 'categorias':
                            if (estado.tipo && estado.subtipo) {
                                urlRetorno = `INICIO.HTML?vista=categorias&tipo=${encodeURIComponent(estado.tipo)}&subtipo=${encodeURIComponent(estado.subtipo)}`;
                                console.log('üéØ Redirigiendo a vista categor√≠as:', urlRetorno);
                            }
                            break;
                        case 'subtipos':
                            if (estado.tipo) {
                                urlRetorno = `INICIO.HTML?vista=subtipos&tipo=${encodeURIComponent(estado.tipo)}`;
                                console.log('üéØ Redirigiendo a vista subtipos:', urlRetorno);
                            }
                            break;
                    }
                    
                    // Redirigir a la vista correspondiente
                    window.location.href = urlRetorno;
                    return;
                } else {
                    console.log('‚è∞ Estado expirado, redirigiendo al inicio');
                    localStorage.removeItem('navegacionAnmago');
                }
            } catch (error) {
                console.error('‚ùå Error procesando estado de navegaci√≥n:', error);
                localStorage.removeItem('navegacionAnmago');
            }
        }
        
        // Fallback: ir al inicio
        console.log('üìç No hay estado guardado, redirigiendo al inicio');
        window.location.href = 'INICIO.HTML';
    }

    // üìù GUARDAR ESTADO DE NAVEGACI√ìN DESDE INICIO.HTML
    function guardarEstadoNavegacion() {
        const urlParams = new URLSearchParams(window.location.search);
        const origen = urlParams.get('origen');
        const tipo = urlParams.get('tipo');
        const subtipo = urlParams.get('subtipo');
        const categoria = urlParams.get('categoria');
        
        if (origen === 'tienda' && tipo && subtipo && categoria) {
            const estadoNavegacion = {
                vistaAnterior: 'productos',
                tipo: tipo,
                subtipo: subtipo,
                categoria: categoria,
                timestamp: Date.now(),
                url: document.referrer
            };
            
            localStorage.setItem('navegacionAnmago', JSON.stringify(estadoNavegacion));
            console.log('üíæ Estado de navegaci√≥n guardado desde URL:', estadoNavegacion);
        } else {
            console.log('üìç No se detectaron par√°metros de navegaci√≥n en URL');
        }
    }

    // ========== INICIALIZACI√ìN MEJORADA ==========
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ INICIANDO CARGA DE PRODUCTO - DOM LISTO');
        
        // 1. Guardar estado de navegaci√≥n (si viene de INICIO.HTML)
        guardarEstadoNavegacion();
        
        // 2. Cargar header y footer
        cargarHeaderFooter();
        
        // 3. Configurar elementos interactivos
        configurarInteracciones();
        
        // 4. Cargar producto (con retardo para asegurar DOM)
        setTimeout(() => {
            console.log('üîÑ Ejecutando carga de producto...');
            cargarProducto();
        }, 500);
        
        // 5. Inicializar contadores
        actualizarContadoresCarrito();
        
        // 6. Activar sistema de zoom
        configurarZoomDobleClic();
    });

    // ========== SISTEMA DE ZOOM MEJORADO CON NAVEGACI√ìN ==========

    // üîç FUNCI√ìN MEJORADA PARA AMPLIAR IMAGEN CON NAVEGACI√ìN
    function ampliarImagen(src) {
        console.log('üîç Ampliando imagen con navegaci√≥n...');
        
        // Obtener √≠ndice de la imagen actual
        const indiceActual = imagenesProducto.indexOf(src);
        if (indiceActual === -1) {
            console.error('‚ùå Imagen no encontrada en la galer√≠a');
            return;
        }
        
        // Crear modal de zoom mejorado
        const modalZoom = document.createElement('div');
        modalZoom.id = 'modal-zoom';
        modalZoom.className = 'modal-zoom-container';
        
        modalZoom.innerHTML = `
            <div class="modal-zoom-content">
                <div class="modal-zoom-image-container">
                    <img src="${src}" 
                         alt="Vista ampliada" 
                         class="modal-zoom-image"
                         onclick="cerrarZoom()">
                    
                    <!-- Botones de navegaci√≥n -->
                    <div class="modal-zoom-controls">
                        <button class="modal-zoom-btn" onclick="navegarImagen(-1)" id="btn-prev" ${indiceActual === 0 ? 'disabled' : ''}>
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="modal-zoom-btn" onclick="navegarImagen(1)" id="btn-next" ${indiceActual === imagenesProducto.length - 1 ? 'disabled' : ''}>
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Bot√≥n cerrar -->
                    <button class="modal-zoom-close" onclick="cerrarZoom()">
                        ‚úï
                    </button>
                </div>
                
                // En la funci√≥n ampliarImagen, modificar esta parte del HTML:

<!-- Footer del modal -->
<div class="modal-zoom-footer">
    <!-- Contador de im√°genes -->
    <div class="modal-zoom-counter">
        ${indiceActual + 1} / ${imagenesProducto.length}
    </div>
    
    <!-- Miniaturas -->
    <div class="modal-zoom-thumbnails" id="modal-thumbnails">
        ${imagenesProducto.map((img, index) => `
            <img src="${img}" 
                 alt="${nombresVariantes[index] || `Variante ${index + 1}`}" 
                 class="modal-zoom-thumbnail ${index === indiceActual ? 'active' : ''}"
                 onclick="cambiarImagenModal(${index})"
                 title="${nombresVariantes[index] || `Variante ${index + 1}`}">
        `).join('')}
    </div>
    
    <!-- Bot√≥n para seleccionar esta variante -->
    <button class="modal-zoom-select-btn" onclick="seleccionarDesdeModal(${indiceActual})">
        <i class="btn btn-gradient px-4 py-2 rounded-pill fw-bold"></i> Seleccionar "${nombresVariantes[indiceActual] || `Variante ${indiceActual + 1}`}"
    </button>
    
    <!-- Informaci√≥n de navegaci√≥n -->
    <div class="modal-zoom-info">
        <i class="bi bi-mouse"></i> Haz clic en la imagen para cerrar ‚Ä¢ 
        <i class="bi bi-arrows-fullscreen"></i> Flechas para navegar ‚Ä¢ 
        <i class="bi bi-escape"></i> ESC para salir
    </div>
</div>
`;
        
        document.body.appendChild(modalZoom);
        
        // Cerrar al hacer clic fuera
        modalZoom.addEventListener('click', function(e) {
            if (e.target === modalZoom) {
                cerrarZoom();
            }
        });
        
        // Cerrar con ESC
        document.addEventListener('keydown', function zoomKeyHandler(e) {
            if (e.key === 'Escape') {
                cerrarZoom();
                document.removeEventListener('keydown', zoomKeyHandler);
            } else if (e.key === 'ArrowLeft') {
                navegarImagen(-1);
            } else if (e.key === 'ArrowRight') {
                navegarImagen(1);
            }
        });
        
        // Prevenir scroll del body
        document.body.style.overflow = 'hidden';
    }

    // ‚û°Ô∏è FUNCI√ìN PARA NAVEGAR ENTRE IM√ÅGENES EN EL MODAL
    function navegarImagen(direccion) {
        const modal = document.getElementById('modal-zoom');
        if (!modal) return;
        
        const imagenActual = modal.querySelector('.modal-zoom-image');
        const indiceActual = imagenesProducto.indexOf(imagenActual.src);
        
        if (indiceActual === -1) return;
        
        const nuevoIndice = indiceActual + direccion;
        
        // Verificar l√≠mites
        if (nuevoIndice < 0 || nuevoIndice >= imagenesProducto.length) {
            return;
        }
        
        // Cambiar imagen con animaci√≥n
        imagenActual.style.opacity = '0';
        
        setTimeout(() => {
            imagenActual.src = imagenesProducto[nuevoIndice];
            imagenActual.style.opacity = '1';
            
            // Actualizar botones de navegaci√≥n
            document.getElementById('btn-prev').disabled = nuevoIndice === 0;
            document.getElementById('btn-next').disabled = nuevoIndice === imagenesProducto.length - 1;
            
            // Actualizar contador
            modal.querySelector('.modal-zoom-counter').textContent = `${nuevoIndice + 1} / ${imagenesProducto.length}`;
            
            // Actualizar miniaturas activas
            const thumbnails = modal.querySelectorAll('.modal-zoom-thumbnail');
            thumbnails.forEach((thumb, index) => {
                thumb.classList.toggle('active', index === nuevoIndice);
            });
            
            // Actualizar bot√≥n de selecci√≥n
            const btnSeleccionar = modal.querySelector('.modal-zoom-select-btn');
            btnSeleccionar.textContent = `Seleccionar "${nombresVariantes[nuevoIndice] || `Variante ${nuevoIndice + 1}`}"`;
            btnSeleccionar.onclick = () => seleccionarDesdeModal(nuevoIndice);
        }, 300);
    }

    // üñºÔ∏è FUNCI√ìN PARA CAMBIAR IMAGEN DESDE MINIATURA EN MODAL
    function cambiarImagenModal(indice) {
        const modal = document.getElementById('modal-zoom');
        if (!modal) return;
        
        const imagenActual = modal.querySelector('.modal-zoom-image');
        
        // Cambiar imagen con animaci√≥n
        imagenActual.style.opacity = '0';
        
        setTimeout(() => {
            imagenActual.src = imagenesProducto[indice];
            imagenActual.style.opacity = '1';
            
            // Actualizar botones de navegaci√≥n
            document.getElementById('btn-prev').disabled = indice === 0;
            document.getElementById('btn-next').disabled = indice === imagenesProducto.length - 1;
            
            // Actualizar contador
            modal.querySelector('.modal-zoom-counter').textContent = `${indice + 1} / ${imagenesProducto.length}`;
            
            // Actualizar miniaturas activas
            const thumbnails = modal.querySelectorAll('.modal-zoom-thumbnail');
            thumbnails.forEach((thumb, index) => {
                thumb.classList.toggle('active', index === indice);
            });
            
            // Actualizar bot√≥n de selecci√≥n
            const btnSeleccionar = modal.querySelector('.modal-zoom-select-btn');
            btnSeleccionar.textContent = `Seleccionar "${nombresVariantes[indice] || `Variante ${indice + 1}`}"`;
            btnSeleccionar.onclick = () => seleccionarDesdeModal(indice);
        }, 300);
    }

    // ‚úÖ FUNCI√ìN PARA SELECCIONAR VARIANTE DESDE EL MODAL
    function seleccionarDesdeModal(indice) {
        const imagenSrc = imagenesProducto[indice];
        const nombreVariante = nombresVariantes[indice] || `Variante ${indice + 1}`;
        
        console.log('üñ±Ô∏è Seleccionando desde modal:', { indice, nombreVariante });
        
        // Actualizar imagen principal
        document.getElementById('imagen-principal').src = imagenSrc;
        
        // Actualizar variables globales
        varianteSeleccionada = nombreVariante;
        imagenSeleccionada = imagenSrc;
        
        // Mostrar variante actual
        mostrarVarianteActual(nombreVariante);
        
        // Actualizar miniaturas en la p√°gina principal
        const miniaturas = document.querySelectorAll('.miniatura');
        miniaturas.forEach((miniatura, index) => {
            miniatura.classList.toggle('active', index === indice);
            miniatura.style.borderColor = index === indice ? '#007bff' : '#ddd';
        });
        
        // Verificar estado del bot√≥n
        verificarEstadoBotonAgregar();
        
        // Cerrar modal
        cerrarZoom();
        
        // Mostrar confirmaci√≥n
        mostrarAlertaTemporal(`‚úÖ Variante seleccionada: "${nombreVariante}"`, 'success');
        
        console.log('‚úÖ Variante cambiada desde modal:', nombreVariante);
    }

    // ‚ùå FUNCI√ìN PARA CERRAR ZOOM
    function cerrarZoom() {
        const modal = document.getElementById('modal-zoom');
        if (modal) {
            modal.remove();
            // Restaurar scroll
            document.body.style.overflow = '';
        }
    }

    // üîÑ ZOOM CON DOBLE CLIC
    function configurarZoomDobleClic() {
        const imagenPrincipal = document.getElementById('imagen-principal');
        if (imagenPrincipal) {
            imagenPrincipal.addEventListener('dblclick', function() {
                ampliarImagen(this.src);
            });
        }
    }

    // ========== FUNCIONES DE INICIALIZACI√ìN ==========
    function cargarHeaderFooter() {
        Promise.all([
            fetch("HEADER.HTML").then(res => res.text()),
            fetch("footer.html").then(res => res.text())
        ]).then(([header, footer]) => {
            document.getElementById("header-container").innerHTML = header;
            document.getElementById("footer-container").innerHTML = footer;
            console.log('‚úÖ Header y footer cargados');
        }).catch(error => {
            console.error("‚ùå Error cargando header/footer:", error);
        });
    }

    function configurarInteracciones() {
        // Configurar input de cantidad
        const inputCantidad = document.getElementById('input-cantidad');
        if (inputCantidad) {
            inputCantidad.addEventListener('change', function() {
                cantidad = Math.max(1, Math.min(10, parseInt(this.value) || 1));
                this.value = cantidad;
            });
        }
    }

    // ========== FUNCIONES PRINCIPALES CORREGIDAS ==========

    // üéØ Obtener ID del producto desde URL
    function obtenerIdProducto() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        console.log('üéØ ID del producto desde URL:', id);
        return id;
    }

    // üì• Cargar datos del producto - VERSI√ìN MEJORADA CON PROMOCIONES
    async function cargarProducto() {
      console.log('üîÑ INICIANDO CARGA DEL PRODUCTO MEJORADA...');
      
      const productoId = obtenerIdProducto();
      
      if (!productoId) {
        console.error('‚ùå No se especific√≥ ID de producto');
        mostrarError('No se especific√≥ ning√∫n producto');
        return;
      }

      try {
        console.log('üîç Buscando producto:', productoId);
        
        const url = "https://raw.githubusercontent.com/anmagoS/ANMAGOPWA/main/catalogo.json?t=" + Date.now();
        console.log('üì° Cargando desde:', url);
        
        const respuesta = await fetch(url);
        
        if (!respuesta.ok) {
          throw new Error(`Error HTTP: ${respuesta.status}`);
        }
        
        const productos = await respuesta.json();
        console.log('üì¶ Cat√°logo cargado:', productos.length, 'productos');
        
        // Buscar producto
        productoActual = productos.find(p => p.id === productoId);
        
        if (!productoActual) {
          console.error('‚ùå Producto no encontrado:', productoId);
          mostrarError('Producto no encontrado en el cat√°logo');
          return;
        }

        console.log('‚úÖ Producto encontrado:', productoActual.producto);
        
        // ‚úÖ CARGAR PROMOCIONES GLOBALES PARA VERIFICAR (CORREGIDO)
        promocionesGlobal = productos.filter(p => {
          const promo = typeof p.promo === "string" ? p.promo.toLowerCase().trim() : p.promo;
          return promo === true || promo === "true" || promo === "s√≠" || promo === "activo" || promo === "si";
        });
        
        console.log('üî• Promociones globales cargadas:', promocionesGlobal.length);
        console.log('üìã Productos en promoci√≥n:', promocionesGlobal.map(p => ({id: p.id, nombre: p.producto})));
        
        // ‚úÖ VERIFICAR SI VIENE DE PROMOCIONES
        const vieneDePromos = vieneDePromociones();
        console.log('üéØ Viene de promociones:', vieneDePromos);
        
        // ‚úÖ INICIALIZAR VARIABLES GLOBALES
        varianteSeleccionada = 'Variante 1';
        cantidad = 1;
        
        // Obtener primera imagen para imagenSeleccionada
        if (productoActual.url && productoActual.url.includes("[]")) {
          imagenesProducto = productoActual.url.split("[]").map(u => u.trim()).filter(Boolean);
          imagenSeleccionada = imagenesProducto[0];
          
          // Generar nombres de variantes
          nombresVariantes = imagenesProducto.map((_, index) => `Variante ${index + 1}`);
        } else {
          imagenesProducto = [productoActual.imagen];
          imagenSeleccionada = productoActual.imagen;
          nombresVariantes = ['Variante 1'];
        }
        
        // ‚úÖ VERIFICAR SI EST√Å EN PROMOCI√ìN ACTUAL
        const estaEnPromo = estaEnPromocionActual(productoId) || vieneDePromos;
        
        console.log('üéØ Variables inicializadas:', {
          varianteSeleccionada,
          imagenSeleccionada,
          cantidad,
          estaEnPromocion: estaEnPromo,
          vieneDePromociones: vieneDePromos,
          imagenesProducto,
          nombresVariantes
        });
        
        // Renderizar producto CON VERIFICACI√ìN DE PROMOCI√ìN
        renderizarProducto(productoActual);
        
        // Cargar productos relacionados
        cargarProductosRelacionados(productos, productoActual);

      } catch (error) {
        console.error('üí• Error cargando producto:', error);
        mostrarError('Error al cargar el producto: ' + error.message);
        
        // ‚úÖ FALLBACK: Intentar cargar producto de ejemplo
        cargarProductoEjemplo(productoId);
      }
    }

    // ‚úÖ FUNCI√ìN DE FALLBACK
    function cargarProductoEjemplo(productoId) {
        console.log('üîÑ Intentando cargar producto de ejemplo...');
        const productoEjemplo = {
            id: productoId,
            producto: "Producto de Ejemplo",
            descripcion: "Este es un producto de ejemplo",
            precio: 29900,
            imagen: "https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg",
            url: "https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg",
            tallas: "S,M,L"
        };
        
        productoActual = productoEjemplo;
        varianteSeleccionada = 'Variante 1';
        imagenesProducto = [productoEjemplo.imagen];
        nombresVariantes = ['Variante 1'];
        imagenSeleccionada = productoEjemplo.imagen;
        cantidad = 1;
        
        renderizarProducto(productoEjemplo);
    }

    // üé® Renderizar producto en la p√°gina CON PRECIOS DIN√ÅMICOS MEJORADO
    function renderizarProducto(producto) {
      console.log('üé® Renderizando producto:', producto.producto);
      
      // 1. Informaci√≥n b√°sica - ACTUALIZAR AMBAS VERSIONES
      document.getElementById('nombre-producto-mobile').textContent = producto.producto;
      document.getElementById('nombre-producto-desktop').textContent = producto.producto;
      document.getElementById('descripcion-producto').textContent = producto.descripcion || 'Producto de alta calidad disponible en Anmago Store.';
      
      // 2. PRECIOS DIN√ÅMICOS - VERIFICAR PROMOCI√ìN ACTUAL
      const precioBase = producto.precio || 0;
      const estaEnPromo = vieneDePromociones() || estaEnPromocionActual(producto.id);
      const precioActual = calcularPrecioConDescuento(producto);
      
      console.log('üí∞ Precios calculados:', {
        producto: producto.producto,
        precioBase,
        estaEnPromo,
        precioActual,
        vieneDePromociones: vieneDePromociones(),
        enBloquePromo: estaEnPromocionActual(producto.id),
        promocionesGlobal: promocionesGlobal.length
      });
      
      // Actualizar precios en ambas versiones
      document.getElementById('precio-actual-mobile').textContent = `$${precioActual.toLocaleString('es-CO')}`;
      document.getElementById('precio-actual-desktop').textContent = `$${precioActual.toLocaleString('es-CO')}`;
      
      // Mostrar precio original y descuento solo si hay promoci√≥n activa (ambas versiones)
      if (estaEnPromo && precioBase > precioActual) {
        // Versi√≥n m√≥vil
        document.getElementById('precio-original-mobile').textContent = `$${precioBase.toLocaleString('es-CO')}`;
        document.getElementById('descuento-mobile').textContent = `-${Math.round((1 - precioActual / precioBase) * 100)}%`;
        document.getElementById('precio-original-mobile').style.display = 'inline';
        document.getElementById('descuento-mobile').style.display = 'inline';
        
        // Versi√≥n desktop
        document.getElementById('precio-original-desktop').textContent = `$${precioBase.toLocaleString('es-CO')}`;
        document.getElementById('descuento-desktop').textContent = `-${Math.round((1 - precioActual / precioBase) * 100)}%`;
        document.getElementById('precio-original-desktop').style.display = 'inline';
        document.getElementById('descuento-desktop').style.display = 'inline';
      } else {
        // Ocultar en ambas versiones
        document.getElementById('precio-original-mobile').style.display = 'none';
        document.getElementById('descuento-mobile').style.display = 'none';
        document.getElementById('precio-original-desktop').style.display = 'none';
        document.getElementById('descuento-desktop').style.display = 'none';
      }

      // 3. Galer√≠a de im√°genes
      renderizarGaleriaConVariantes(producto);

      // 4. Breadcrumb
      renderizarBreadcrumb(producto);

      // 5. Selector de variables (colores/materiales)
      renderizarVariables(producto);

      // 6. Selector de tallas
      renderizarTallas(producto);

      // 7. Badges - MOSTRAR BADGE SI EST√Å EN PROMOCI√ìN ACTUAL
      renderizarBadges(producto, estaEnPromo);

      // 8. Video
      renderizarVideo(producto);
      
      console.log('‚úÖ Producto renderizado completamente');
    }

    // üñºÔ∏è Renderizar galer√≠a CON MINIATURAS PEQUE√ëAS
    function renderizarGaleriaConVariantes(producto) {
        const imagenPrincipal = document.getElementById('imagen-principal');
        const galeria = document.getElementById('galeria-miniaturas');
        const alertaSeleccion = document.getElementById('alerta-seleccion-imagen');
        
        console.log('üñºÔ∏è Im√°genes para galer√≠a:', imagenesProducto.length);

        if (imagenesProducto.length === 0) {
            imagenPrincipal.src = 'https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg';
            return;
        }

        // Imagen principal
        imagenPrincipal.src = imagenesProducto[0];
        imagenPrincipal.alt = producto.producto;
        
        // ‚úÖ VARIANTE POR DEFECTO
        varianteSeleccionada = nombresVariantes[0];
        imagenSeleccionada = imagenesProducto[0];
        
        // Mostrar variante actual
        mostrarVarianteActual(nombresVariantes[0]);

        // MINIATURAS PEQUE√ëAS Y SELECCIONABLES
        if (imagenesProducto.length > 1) {
            galeria.innerHTML = imagenesProducto.map((img, index) => {
                const nombreVariante = nombresVariantes[index];
                return `
                    <img src="${img}" 
                         alt="${producto.producto} - ${nombreVariante}" 
                         class="miniatura ${index === 0 ? 'active' : ''}"
                         onclick="seleccionarImagenYVariante('${img}', '${nombreVariante}', this)"
                         style="width: 80px; height: 80px; object-fit: cover; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; margin: 5px; transition: all 0.3s ease;"
                         onmouseover="this.style.borderColor='#007bff'"
                         onmouseout="if(!this.classList.contains('active')) this.style.borderColor='#ddd'"
                         title="${nombreVariante}">
                `;
            }).join('');
            
            console.log('‚úÖ Miniaturas creadas:', imagenesProducto.length);
            
            // Mostrar alerta si hay m√∫ltiples im√°genes
            alertaSeleccion.style.display = 'block';
        } else {
            galeria.innerHTML = '';
            alertaSeleccion.style.display = 'none';
        }
    }

    // ‚úÖ FUNCI√ìN: Mostrar variante actual
    function mostrarVarianteActual(nombreVariante) {
        const container = document.getElementById('variante-actual-container');
        const texto = document.getElementById('variante-actual-texto');
        const alertaSeleccion = document.getElementById('alerta-seleccion-imagen');
        
        texto.textContent = nombreVariante;
        container.style.display = 'block';
        
        // Ocultar alerta cuando se selecciona una imagen
        alertaSeleccion.style.display = 'none';
    }

    // ‚úÖ FUNCI√ìN: Seleccionar imagen Y variante
    function seleccionarImagenYVariante(imagenSrc, variante, elemento) {
        console.log('üñ±Ô∏è Seleccionando variante:', variante);
        
        // Cambiar imagen principal
        document.getElementById('imagen-principal').src = imagenSrc;
        
        // Actualizar variables globales
        varianteSeleccionada = variante;
        imagenSeleccionada = imagenSrc;
        
        // Mostrar variante actual
        mostrarVarianteActual(variante);
        
        // Actualizar miniaturas activas
        document.querySelectorAll('.miniatura').forEach(img => {
            img.classList.remove('active');
            img.style.borderColor = '#ddd';
        });
        elemento.classList.add('active');
        elemento.style.borderColor = '#007bff';
        
        // Verificar estado del bot√≥n
        verificarEstadoBotonAgregar();
        
        console.log('‚úÖ Variante cambiada a:', variante);
    }

    // üé® Renderizar selector de variables (colores/materiales)
    function renderizarVariables(producto) {
        const contenedor = document.getElementById('seccion-variables');
        
        // Verificar si el producto tiene variables
        const tieneVariables = producto.variables && 
                              producto.variables.trim() !== "" && 
                              producto.variables !== "N/A" &&
                              producto.variables.toLowerCase() !== "√∫nica" &&
                              producto.variables.toLowerCase() !== "unica";
        
        if (tieneVariables) {
            const variables = producto.variables.split(",").map(v => v.trim()).filter(v => v);
            console.log('üé® Variables disponibles:', variables);

            contenedor.innerHTML = `
                <h5 class="fw-bold mb-3">üé® Selecciona color/material</h5>
                <select class="form-select selector-variable" onchange="seleccionarVariable(this.value)" style="max-width: 250px; font-size: 1rem; padding: 10px;">
                    <option value="">-- Elige una opci√≥n --</option>
                    ${variables.map(variable => `<option value="${variable}">${variable}</option>`).join('')}
                </select>
                <div class="form-text mt-2">üí° Selecciona tu color o material preferido</div>
            `;
        } else {
            contenedor.innerHTML = '';
            // Si no hay variables, habilitar bot√≥n (solo necesita variante)
            verificarEstadoBotonAgregar();
        }
    }

    // üìè Renderizar selector de tallas - VERSI√ìN MEJORADA
    function renderizarTallas(producto) {
        const contenedor = document.getElementById('seccion-tallas');
        
        // Verificar si el producto necesita selector de tallas
        const necesitaTallas = producto.tallas && 
                             producto.tallas.trim() !== "" && 
                             producto.tallas !== "N/A" && 
                             producto.tallas.toLowerCase() !== "√∫nica" &&
                             producto.tallas.toLowerCase() !== "unica";

        if (necesitaTallas) {
            const tallas = producto.tallas.split(",").map(t => t.trim()).filter(t => t);
            console.log('üìè Tallas disponibles:', tallas);

            contenedor.innerHTML = `
                <h5 class="fw-bold mb-3">üìè Selecciona tu talla</h5>
                <select class="form-select selector-talla" onchange="seleccionarTalla(this.value)" style="max-width: 250px; font-size: 1rem; padding: 10px;">
                    <option value="">-- Elige una talla --</option>
                    ${tallas.map(talla => `<option value="${talla}">${talla}</option>`).join('')}
                </select>
                <div class="form-text mt-2">üí° Aseg√∫rate de seleccionar tu talla correcta</div>
            `;
        } else {
            contenedor.innerHTML = '';
            // Si no hay tallas, habilitar bot√≥n (solo necesita variante)
            verificarEstadoBotonAgregar();
        }
    }

    // ‚úÖ FUNCI√ìN: Seleccionar variable (color/material)
    function seleccionarVariable(variable) {
        console.log('üé® Variable seleccionada:', variable);
        variableSeleccionada = variable;
        verificarEstadoBotonAgregar();
    }

    // ‚úÖ FUNCI√ìN: Seleccionar talla
    function seleccionarTalla(talla) {
        console.log('üìè Talla seleccionada:', talla);
        tallaSeleccionada = talla;
        verificarEstadoBotonAgregar();
    }

    // ‚úÖ FUNCI√ìN: Verificar estado del bot√≥n - VERSI√ìN MEJORADA
    function verificarEstadoBotonAgregar() {
        const btnAgregar = document.getElementById('btn-agregar-carrito');
        const btnComprar = document.querySelector('.btn-gradient');
        
        const necesitaVariables = productoActual?.variables && 
                                productoActual.variables.trim() !== "" && 
                                productoActual.variables !== "N/A" &&
                                productoActual.variables.toLowerCase() !== "√∫nica" &&
                                productoActual.variables.toLowerCase() !== "unica";
        
        const necesitaTallas = productoActual?.tallas && 
                             productoActual.tallas.trim() !== "" && 
                             productoActual.tallas !== "N/A" && 
                             productoActual.tallas.toLowerCase() !== "√∫nica" &&
                             productoActual.tallas.toLowerCase() !== "unica";
        
        let puedeAgregar = varianteSeleccionada;
        
        if (necesitaVariables) {
            puedeAgregar = puedeAgregar && variableSeleccionada;
        }
        
        if (necesitaTallas) {
            puedeAgregar = puedeAgregar && tallaSeleccionada;
        }
        
        if (btnAgregar) {
            btnAgregar.disabled = !puedeAgregar;
            // Cambiar texto del bot√≥n seg√∫n estado
            if (!varianteSeleccionada) {
                btnAgregar.innerHTML = '<i class="bi bi-image"></i> Selecciona una imagen';
            } else if (necesitaVariables && !variableSeleccionada) {
                btnAgregar.innerHTML = '<i class="bi bi-palette"></i> Selecciona color/material';
            } else if (necesitaTallas && !tallaSeleccionada) {
                btnAgregar.innerHTML = '<i class="bi bi-rulers"></i> Selecciona talla';
            } else {
                btnAgregar.innerHTML = '<i class="bi bi-cart-plus"></i> Agregar al carrito';
            }
        }
        
        if (btnComprar) btnComprar.disabled = !puedeAgregar;
        
        console.log('üîò Estado botones:', puedeAgregar ? 'HABILITADO' : 'DESHABILITADO', {
            varianteSeleccionada,
            variableSeleccionada,
            tallaSeleccionada,
            necesitaVariables,
            necesitaTallas
        });
    }

    // üî¢ Cambiar cantidad
    function cambiarCantidad(delta) {
        cantidad = parseInt(document.getElementById('input-cantidad').value) + delta;
        cantidad = Math.max(1, Math.min(10, cantidad));
        document.getElementById('input-cantidad').value = cantidad;
    }

    // üõí Agregar al carrito - CON PRECIO DIN√ÅMICO SEG√öN PROMOCI√ìN
    function agregarAlCarrito() {
      console.log('üéØ EJECUTANDO agregarAlCarrito CON PRECIO DIN√ÅMICO...');
      
      // 1. VALIDACIONES MEJORADAS
      if (!productoActual) {
          console.error('‚ùå ERROR CR√çTICO: productoActual no definido');
          mostrarAlertaTemporal('‚ùå Error: El producto no se carg√≥ correctamente', 'danger');
          return false;
      }
      
      if (!varianteSeleccionada) {
          mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona una imagen/variante', 'warning');
          document.getElementById('galeria-miniaturas').scrollIntoView({ behavior: 'smooth' });
          return false;
      }

      const necesitaVariables = productoActual?.variables && 
                              productoActual.variables.trim() !== "" && 
                              productoActual.variables !== "N/A" &&
                              productoActual.variables.toLowerCase() !== "√∫nica" &&
                              productoActual.variables.toLowerCase() !== "unica";
      
      const necesitaTallas = productoActual?.tallas && 
                           productoActual.tallas.trim() !== "" && 
                           productoActual.tallas !== "N/A" && 
                           productoActual.tallas.toLowerCase() !== "√∫nica" &&
                           productoActual.tallas.toLowerCase() !== "unica";
      
      if (necesitaVariables && !variableSeleccionada) {
          mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona un color/material', 'warning');
          document.getElementById('seccion-variables').scrollIntoView({ behavior: 'smooth' });
          return false;
      }

      if (necesitaTallas && !tallaSeleccionada) {
          mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona una talla', 'warning');
          document.getElementById('seccion-tallas').scrollIntoView({ behavior: 'smooth' });
          return false;
      }

      // 2. CREAR PRODUCTO CON PRECIO DIN√ÅMICO
      const precioFinal = calcularPrecioConDescuento(productoActual);
      const estaEnPromo = vieneDePromociones() || estaEnPromocionActual(productoActual.id);
      
      const productoCarrito = {
          id: productoActual.id + 
              '-' + varianteSeleccionada + 
              (variableSeleccionada ? '-' + variableSeleccionada.replace(/\s+/g, '_') : '') +
              (tallaSeleccionada ? '-' + tallaSeleccionada : ''),
          nombre: `${productoActual.producto} - ${varianteSeleccionada}` +
                  (variableSeleccionada ? ` - ${variableSeleccionada}` : '') +
                  (tallaSeleccionada ? ` - Talla ${tallaSeleccionada}` : ''),
          // ‚úÖ PRECIO DIN√ÅMICO: Aplica descuento si est√° en promoci√≥n
          precio: precioFinal,
          imagen: imagenSeleccionada,
          variante: varianteSeleccionada,
          variable: variableSeleccionada || '√önica',
          talla: tallaSeleccionada || '√önica',
          cantidad: cantidad,
          // ‚úÖ GUARDAR INFORMACI√ìN DE PROMOCI√ìN
          enPromocion: estaEnPromo,
          precioOriginal: productoActual.precio || 0,
          vieneDePromociones: vieneDePromociones()
      };

      console.log('üõí Producto para carrito:', productoCarrito);

      // 3. AGREGAR AL CARRITO - USANDO M√âTODO CORRECTO
      if (window.carritoManager && typeof window.carritoManager.agregarProducto === 'function') {
          // ‚úÖ M√âTODO CORRECTO: agregarProducto()
          const resultado = window.carritoManager.agregarProducto(productoCarrito);
          console.log('‚úÖ Resultado de agregarProducto:', resultado);
          
          if (resultado) {
              mostrarConfirmacionAgregado();
              return true;
          } else {
              mostrarAlertaTemporal('‚ùå Error al agregar al carrito', 'danger');
              return false;
          }
      } else {
          console.warn('‚ö†Ô∏è carritoManager no disponible, usando fallback...');
          
          // FALLBACK MANUAL
          try {
              const carrito = JSON.parse(localStorage.getItem('carritoAnmago') || '[]');
              
              // Buscar si ya existe
              const existeIndex = carrito.findIndex(item => 
                  item.id === productoCarrito.id
              );
              
              if (existeIndex > -1) {
                  carrito[existeIndex].cantidad += productoCarrito.cantidad;
              } else {
                  carrito.push(productoCarrito);
              }
              
              localStorage.setItem('carritoAnmago', JSON.stringify(carrito));
              console.log('‚úÖ Producto agregado via localStorage');
              
              // Actualizar contadores
              actualizarContadoresCarrito();
              mostrarConfirmacionAgregado();
              return true;
              
          } catch (error) {
              console.error('‚ùå Error en fallback:', error);
              mostrarAlertaTemporal('‚ùå Error cr√≠tico al agregar al carrito', 'danger');
              return false;
          }
      }
    }

    // ‚ö° Comprar ahora
    function comprarAhora() {
        if (!varianteSeleccionada) {
            mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona una imagen (variante) del producto', 'warning');
            return;
        }

        const necesitaVariables = productoActual?.variables && 
                                productoActual.variables.trim() !== "" && 
                                productoActual.variables !== "N/A" &&
                                productoActual.variables.toLowerCase() !== "√∫nica" &&
                                productoActual.variables.toLowerCase() !== "unica";
        
        const necesitaTallas = productoActual?.tallas && 
                             productoActual.tallas.trim() !== "" && 
                             productoActual.tallas !== "N/A" && 
                             productoActual.tallas.toLowerCase() !== "√∫nica" &&
                             productoActual.tallas.toLowerCase() !== "unica";
        
        if (necesitaVariables && !variableSeleccionada) {
            mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona un color/material', 'warning');
            return;
        }

        if (necesitaTallas && !tallaSeleccionada) {
            mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona una talla', 'warning');
            return;
        }

        if (agregarAlCarrito()) {
            setTimeout(() => {
                abrirFormularioPedido();
            }, 500);
        }
    }

    // ‚úÖ Mostrar confirmaci√≥n
    function mostrarConfirmacionAgregado() {
        const btn = document.getElementById('btn-agregar-carrito');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="bi bi-check2"></i> ¬°Agregado!';
        btn.classList.remove('btn-agregar-carrito');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-agregar-carrito');
        }, 2000);
    }

    // üö® Funci√≥n para mostrar alertas temporales
    function mostrarAlertaTemporal(mensaje, tipo = 'warning') {
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
        alerta.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
        alerta.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alerta);
        
        // Auto-eliminar despu√©s de 4 segundos
        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 4000);
    }

    // ========== FUNCIONES RESTANTES ==========

    function renderizarBreadcrumb(producto) {
        const breadcrumbMobile = document.getElementById('breadcrumb-producto-mobile');
        const breadcrumbDesktop = document.getElementById('breadcrumb-producto-desktop');
        
        let categorias = [];
        
        if (producto.tipo) categorias.push(producto.tipo);
        if (producto.categoria) categorias.push(producto.categoria);
        if (producto.subcategoria) categorias.push(producto.subcategoria);
        
        const breadcrumbItems = categorias.map(cat => 
            `<li class="breadcrumb-item"><a href="INICIO.HTML?categoria=${cat}">${cat}</a></li>`
        ).join('');
        
        const breadcrumbFinal = breadcrumbItems + 
            `<li class="breadcrumb-item active" aria-current="page">${producto.producto}</li>`;
        
        // Actualizar ambas versiones
        if (breadcrumbMobile) breadcrumbMobile.innerHTML = breadcrumbMobile.firstElementChild.outerHTML + breadcrumbFinal;
        if (breadcrumbDesktop) breadcrumbDesktop.innerHTML = breadcrumbDesktop.firstElementChild.outerHTML + breadcrumbFinal;
    }

    // üè∑Ô∏è Renderizar badges con verificaci√≥n de promoci√≥n actual
    function renderizarBadges(producto, estaEnPromo) {
      const contenedor = document.getElementById('badges-producto');
      const badges = [];

      // ‚úÖ BADGE DE OFERTA SOLO SI EST√Å EN PROMOCI√ìN ACTUAL
      if (estaEnPromo) {
        badges.push('<span class="badge bg-danger me-2">üî• Oferta Activa</span>');
      }
      
      if (producto.nuevo) {
        badges.push('<span class="badge bg-success me-2">üÜï Nuevo</span>');
      }
      
      if (producto.stock <= 5 && producto.stock > 0) {
        badges.push('<span class="badge bg-warning me-2">‚ö†Ô∏è √öltimas unidades</span>');
      }

      contenedor.innerHTML = badges.join('');
    }

    // üé• FUNCI√ìN MEJORADA PARA RENDERIZAR VIDEO DE YOUTUBE
    function renderizarVideo(producto) {
        const contenedorDesktop = document.getElementById('video-producto-desktop');
        const contenedorMobile = document.getElementById('video-producto-mobile');
        
        if (!producto.video_url) {
            contenedorDesktop.style.display = 'none';
            contenedorMobile.style.display = 'none';
            return;
        }

        // Convertir URL de YouTube a embed
        function convertirUrlYouTube(url) {
            // Si ya es una URL embed, devolverla tal cual
            if (url.includes('youtube.com/embed')) {
                return url;
            }
            
            // Si es un enlace de YouTube normal, convertirlo a embed
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                
                // Extraer ID del video de diferentes formatos
                if (url.includes('youtube.com/watch?v=')) {
                    videoId = url.split('v=')[1]?.split('&')[0];
                } else if (url.includes('youtu.be/')) {
                    videoId = url.split('youtu.be/')[1]?.split('?')[0];
                } else if (url.includes('youtube.com/shorts/')) {
                    videoId = url.split('shorts/')[1]?.split('?')[0];
                }
                
                if (videoId) {
                    return `https://www.youtube.com/embed/${videoId}`;
                }
            }
            
            return url;
        }

        const videoUrlEmbed = convertirUrlYouTube(producto.video_url);

        // Crear el HTML del video
        const videoHTML = `
            <div class="mb-4">
                <h5 class="fw-bold mb-3">üé• Video del producto</h5>
                <div class="ratio ratio-16x9">
                    <iframe 
                        src="${videoUrlEmbed}" 
                        title="Video del producto: ${producto.producto}"
                        class="rounded shadow"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="bi bi-play-circle"></i> Haz clic para ver el video del producto
                    </small>
                </div>
            </div>
        `;

        // Asignar a ambos contenedores
        contenedorDesktop.innerHTML = videoHTML;
        contenedorMobile.innerHTML = videoHTML;
        
        // Asegurar que los contenedores sean visibles seg√∫n su clase
        contenedorDesktop.style.display = ''; // Se controla con clases Bootstrap
        contenedorMobile.style.display = '';  // Se controla con clases Bootstrap
        
        console.log('üé• Video renderizado:', {
            urlOriginal: producto.video_url,
            urlEmbed: videoUrlEmbed,
            posicionDesktop: 'Debajo de im√°genes',
            posicionMobile: 'Antes de descripci√≥n'
        });
    }

    function cargarProductosRelacionados(productos, productoActual) {
      const relacionados = productos
        .filter(p => p.id !== productoActual.id && 
            (p.tipo === productoActual.tipo || 
             p.categoria === productoActual.categoria))
        .slice(0, 4);

      const contenedor = document.getElementById('productos-relacionados');
      
      if (relacionados.length === 0) {
        contenedor.innerHTML = '<p class="text-muted text-center py-4">No hay productos relacionados</p>';
        return;
      }

      contenedor.innerHTML = relacionados.map(producto => {
        // ‚úÖ PRECIOS CORRECTOS EN PRODUCTOS RELACIONADOS CON VERIFICACI√ìN DE PROMOCI√ìN
        const precioMostrar = calcularPrecioConDescuento(producto);
        const precioOriginal = producto.precio || 0;
        const estaEnPromo = vieneDePromociones() || estaEnPromocionActual(producto.id);
        
        return `
        <div class="card-producto-ml">
          <a href="PRODUCTO.HTML?id=${producto.id}">
            <img src="${producto.imagen}" alt="${producto.producto}" class="card-img-ml imagen-completa">
            <div class="card-body-ml">
              <h3 class="nombre-producto-ml small line-clamp-2">${producto.producto}</h3>
              <div class="d-flex align-items-center gap-2">
                <p class="precio-ml fw-bold text-primary mb-0">$${precioMostrar.toLocaleString('es-CO')}</p>
                ${estaEnPromo && precioOriginal > precioMostrar ? 
                  `<span class="text-muted small text-decoration-line-through">$${precioOriginal.toLocaleString('es-CO')}</span>` : ''}
              </div>
              ${estaEnPromo ? '<span class="badge bg-danger small">Oferta</span>' : ''}
              <span class="btn btn-outline-primary btn-sm mt-2">Ver detalle</span>
            </div>
          </a>
        </div>
        `;
      }).join('');
    }

    function mostrarError(mensaje) {
        const main = document.querySelector('main');
        main.innerHTML = `
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-md-6 text-center">
                        <i class="bi bi-emoji-frown fs-1 text-muted mb-4"></i>
                        <h3 class="h4 text-muted mb-3">${mensaje}</h3>
                        <p class="text-muted mb-4">Estamos teniendo problemas t√©cnicos. Por favor intenta:</p>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-center">
                            <button class="btn btn-primary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> Reintentar
                            </button>
                            <a href="INICIO.HTML" class="btn btn-outline-primary">
                                <i class="bi bi-house"></i> Volver al inicio
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // üîÑ Actualizar contadores del carrito
    function actualizarContadoresCarrito() {
        const carrito = JSON.parse(localStorage.getItem('carritoAnmago') || '[]');
        const totalItems = carrito.reduce((total, item) => total + (item.cantidad || 1), 0);
        
        ['contador-carrito', 'contador-carrito-mobile'].forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = totalItems;
                elemento.style.display = totalItems > 0 ? 'block' : 'none';
            }
        });
    }

    // üìã Abrir formulario de pedido
    function abrirFormularioPedido() {
        window.location.href = 'modalformulario.html';
    }

    // ========== FUNCIONES GLOBALES ==========
    window.volverAtras = volverAtras;
    window.seleccionarImagenYVariante = seleccionarImagenYVariante;
    window.seleccionarVariable = seleccionarVariable;
    window.seleccionarTalla = seleccionarTalla;
    window.cambiarCantidad = cambiarCantidad;
    window.agregarAlCarrito = agregarAlCarrito;
    window.comprarAhora = comprarAhora;
    window.ampliarImagen = ampliarImagen;
    window.cerrarZoom = cerrarZoom;
    window.navegarImagen = navegarImagen;
    window.cambiarImagenModal = cambiarImagenModal;
    window.seleccionarDesdeModal = seleccionarDesdeModal;
    window.abrirFormularioPedido = abrirFormularioPedido;  
  </script>

  <!-- SCRIPTS EXTERNOS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="buscador.js?v=20251115"></script>
</body>
</html>
