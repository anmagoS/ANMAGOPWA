<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Categor√≠as | Anmago Store - Los Mejores Precios</title>
  <meta name="description" content="Explora nuestras categor√≠as de productos. Encuentra lo que buscas por tipo y subtipo en Anmago Store.">
  
  <!-- Preconexiones optimizadas -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://ik.imagekit.io">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- PWA y favicon -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.jpg" type="image/x-icon" />

  <!-- Bootstrap e iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

  <!-- CSS optimizado -->
  <link rel="stylesheet" href="ESTILO.CSS?v=20251115" />
</head>

<body class="bg-light">
  <!-- Scripts optimizados -->
  <script src="app.js?v=20251115" defer></script>
  <script src="carrito.js?v=20251115" defer></script>
  <script src="buscador.js?v=20251115" type="module"></script>

  <!-- HEADER STICKY -->
  <div id="header-container" class="header-sticky"></div>

  <!-- BANNER PROMOCIONAL -->
  <div class="container-fluid banner-promocional py-2">
    <div class="container text-center">
      <small class="fw-bold">‚≠ê Los mejores precios ‚≠ê Calidad garantizada</small>
    </div>
  </div>

  <!-- BUSCADOR TIPO MERCADOLIBRE -->
  <div class="container mt-3">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8">
        <div class="position-relative">
          <input id="buscador" class="form-control buscador-ml" 
                 placeholder="Buscar productos, marcas y m√°s..." 
                 autocomplete="on">
          <div id="sugerencias" class="dropdown-menu position-absolute mt-1 w-100 z-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOT√ìN ATR√ÅS -->
  <div class="container mt-3">
    <a href="javascript:history.back()" class="btn btn-outline-dark">
      <i class="bi bi-arrow-left"></i> Volver atr√°s
    </a>
  </div>

  <!-- BOT√ìN PROMOCIONES -->
  <div class="container text-center mt-3">
    <a href="PROMOS.HTML" class="btn btn-warning fw-bold px-4 py-2 rounded-pill">
      üéÅ Ofertas Especiales
    </a>
  </div>

  <!-- CONTENIDO PRINCIPAL - CATEGOR√çAS -->
  <main class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 fw-bold mb-0" id="titulo-categorias">Categor√≠as</h1>
    </div>
    
    <div id="grid-categorias" class="grid-productos-ml">
      <!-- Las categor√≠as se cargan din√°micamente -->
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
    </div>
  </main>

  <!-- SECCI√ìN SUBTIPOS RELACIONADOS -->
  <section class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h4 fw-bold mb-0">‚ú® M√°s subtipos relacionados</h2>
    </div>
    
    <div id="seccion-subtipos" class="grid-productos-ml">
      <!-- Los subtipos se cargan din√°micamente -->
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
    </div>
  </section>

  <!-- CARRITO OFFCANVAS -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCarrito">
    <div class="offcanvas-header border-bottom">
      <h4 class="offcanvas-title fw-bold">üõí Tu Carrito</h4>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body" id="carrito-contenido">
      <div class="text-center text-muted py-4">
        <i class="bi bi-bag-x fs-1"></i>
        <p class="mt-2">Tu carrito est√° vac√≠o</p>
      </div>
    </div>
    <div class="offcanvas-footer p-3 border-top">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="fw-bold">Subtotal:</span>
        <span id="subtotal" class="fw-bold fs-5 text-primary">$0</span>
      </div>
      <button class="btn btn-primary w-100 py-2 fw-bold" onclick="abrirFormularioPedido()">
        Continuar compra
      </button>
    </div>
  </div>

  <!-- BOT√ìN CARRITO FLOTANTE -->
  <a href="#" class="btn-carrito-flotante d-none d-md-flex" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
    <i class="bi bi-bag-heart fs-5"></i>
    <span id="contador-carrito" class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill" style="font-size: 0.7rem;">0</span>
  </a>

  <!-- FOOTER -->
  <div id="footer-container" class="mt-5"></div>

  <!-- BARRA INFERIOR MOBILE -->
  <nav class="navbar fixed-bottom bg-white border-top d-md-none py-2">
    <div class="container-fluid">
      <div class="d-flex justify-content-around w-100">
        <a href="INICIO.HTML" class="text-center text-decoration-none text-primary">
          <i class="bi bi-house-fill fs-5"></i>
          <div class="small">Inicio</div>
        </a>
        <a href="PROMOS.HTML" class="text-center text-decoration-none text-dark">
          <i class="bi bi-percent fs-5"></i>
          <div class="small">Ofertas</div>
        </a>
        <a href="#" class="text-center text-decoration-none position-relative"
           data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
          <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
               style="width: 50px; height: 50px; margin-top: -8px;">
            <i class="bi bi-bag-heart fs-5 text-white"></i>
          </div>
          <span id="contador-carrito-mobile" class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill" style="font-size: 0.6rem;">0</span>
          <div class="small mt-1">Carrito</div>
        </a>
        <a href="CATEGORIAS.HTML" class="text-center text-decoration-none text-dark">
          <i class="bi bi-grid fs-5"></i>
          <div class="small">Categor√≠as</div>
        </a>
        <a href="modalformulario.html" class="text-center text-decoration-none text-dark">
          <i class="bi bi-person fs-5"></i>
          <div class="small">Cuenta</div>
        </a>
      </div>
    </div>
  </nav>

  <!-- SCRIPTS EXTERNOS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- JAVASCRIPT OPTIMIZADO -->
  <script type="module">
    import { activarBuscadorGlobal } from './buscador.js';

    // üéØ Obtener par√°metros desde URL
    function getParametrosDesdeURL() {
      const params = new URLSearchParams(window.location.search);
      return {
        tipo: params.get("tipo")?.trim(),
        subtipo: params.get("subtipo")?.trim()
      };
    }

    // üì• Cargar cat√°logo
    async function cargarCatalogo() {
      try {
        const url = "https://raw.githubusercontent.com/anmagoS/ANMAGOPWA/main/catalogo.json?v=" + Date.now();
        const respuesta = await fetch(url);
        const productos = await respuesta.json();
        window.catalogoGlobal = productos;
        renderCategoriasML(productos);
        renderizarSubtiposRelacionadosML(productos);
      } catch (error) {
        console.error("‚ùå Error cargando cat√°logo:", error);
        mostrarErrorCategorias();
      }
    }

    // üé® Renderizar categor√≠as estilo MercadoLibre
    function renderCategoriasML(productos) {
      const { tipo, subtipo } = getParametrosDesdeURL();
      const contenedor = document.getElementById("grid-categorias");
      
      if (!tipo || !subtipo || !contenedor) {
        contenedor.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">Par√°metros incompletos.</p></div>';
        return;
      }

      // Actualizar t√≠tulo
      document.getElementById("titulo-categorias").textContent = `${subtipo}`;

      const productosFiltrados = productos.filter(p =>
        p.tipo?.trim().toUpperCase() === tipo.toUpperCase() &&
        p.subtipo?.trim().toUpperCase() === subtipo.toUpperCase()
      );

      const categoriasMap = new Map();

      productosFiltrados.forEach(p => {
        const categoriaKey = p.categoria?.trim().toUpperCase();
        if (categoriaKey && !categoriasMap.has(categoriaKey)) {
          categoriasMap.set(categoriaKey, p);
        }
      });

      if (categoriasMap.size === 0) {
        contenedor.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No hay categor√≠as disponibles.</p></div>';
        return;
      }

      contenedor.innerHTML = Array.from(categoriasMap.entries()).map(([categoriaKey, productoRef]) => {
        const categoriaOriginal = productoRef.categoria?.trim();
        const imagen = productoRef.imagen || "https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg";
        
        return `
          <div class="card-producto-ml">
            <a href="PRODUCTOS.HTML?tipo=${encodeURIComponent(tipo)}&subtipo=${encodeURIComponent(subtipo)}&categoria=${encodeURIComponent(categoriaOriginal)}" class="text-decoration-none">
              <img src="${imagen}" 
                   alt="${categoriaOriginal}" 
                   class="card-img-ml" 
                   loading="lazy"
                   onerror="this.src='https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg'">
              <div class="card-body-ml">
                <h3 class="nombre-producto-ml small text-dark mb-2">${categoriaOriginal}</h3>
                <div class="d-grid">
                  <span class="btn btn-outline-primary btn-sm">Ver productos</span>
                </div>
              </div>
            </a>
          </div>
        `;
      }).join('');

      console.log("‚úÖ Categor√≠as renderizadas:", Array.from(categoriasMap.keys()));
    }

    // üé® Renderizar subtipos relacionados
    function renderizarSubtiposRelacionadosML(productos) {
      const { tipo, subtipo: subtipoActual } = getParametrosDesdeURL();
      const contenedor = document.getElementById("seccion-subtipos");
      
      if (!contenedor || !tipo) {
        contenedor.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No hay subtipos relacionados.</p></div>';
        return;
      }

      const productosFiltrados = productos.filter(p =>
        p.tipo?.trim().toUpperCase() === tipo.toUpperCase()
      );

      const subtiposUnicos = [...new Set(productosFiltrados.map(p => p.subtipo?.trim().toUpperCase()).filter(Boolean))]
        .filter(sub => sub && sub !== subtipoActual?.toUpperCase())
        .slice(0, 6); // Limitar a 6 subtipos

      if (subtiposUnicos.length === 0) {
        contenedor.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No hay otros subtipos disponibles.</p></div>';
        return;
      }

      contenedor.innerHTML = subtiposUnicos.map(subtipoKey => {
        const productoRef = productosFiltrados.find(p =>
          p.subtipo?.trim().toUpperCase() === subtipoKey
        );
        const subtipoOriginal = productoRef?.subtipo?.trim() || subtipoKey;
        const imagen = productoRef?.imagen || "https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg";
        
        return `
          <div class="card-producto-ml">
            <a href="CATEGORIAS.HTML?tipo=${encodeURIComponent(tipo)}&subtipo=${encodeURIComponent(subtipoOriginal)}" class="text-decoration-none">
              <img src="${imagen}" 
                   alt="${subtipoOriginal}" 
                   class="card-img-ml" 
                   loading="lazy"
                   onerror="this.src='https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg'">
              <div class="card-body-ml">
                <h3 class="nombre-producto-ml small text-dark mb-2">${subtipoOriginal}</h3>
                <div class="d-grid">
                  <span class="btn btn-outline-primary btn-sm">Explorar</span>
                </div>
              </div>
            </a>
          </div>
        `;
      }).join('');

      console.log("‚úÖ Subtipos relacionados renderizados:", subtiposUnicos);
    }

    // ‚ùå Mostrar error
    function mostrarErrorCategorias() {
      const contenedor = document.getElementById("grid-categorias");
      if (contenedor) {
        contenedor.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="bi bi-emoji-frown fs-1 text-muted"></i>
            <p class="text-muted mt-2">No pudimos cargar las categor√≠as</p>
            <button class="btn btn-outline-primary mt-2" onclick="cargarCatalogo()">
              <i class="bi bi-arrow-clockwise"></i> Reintentar
            </button>
          </div>
        `;
      }
    }

    // üöÄ Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", async () => {
      // Cargar header
      try {
        const header = await fetch("HEADER.HTML").then(res => res.text());
        document.getElementById("header-container").innerHTML = header;
      } catch (error) {
        console.error("Error cargando header:", error);
      }

      // Cargar footer
      try {
        const footer = await fetch("footer.html").then(res => res.text());
        document.getElementById("footer-container").innerHTML = footer;
      } catch (error) {
        console.error("Error cargando footer:", error);
      }

      // Activar buscador
      activarBuscadorGlobal();

      // Cargar cat√°logo
      setTimeout(cargarCatalogo, 100);
    });

    // üåê Funciones globales
    window.abrirFormularioPedido = function() {
      window.open('modalformulario.html', '_blank');
    };

    window.cargarCatalogo = cargarCatalogo;
  </script>
</body>
</html>
