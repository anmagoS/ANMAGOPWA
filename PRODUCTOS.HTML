<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Productos | Anmago Store - Los Mejores Precios</title>
  <meta name="description" content="Explora nuestros productos por categor√≠a. Encuentra lo que buscas en ropa, relojer√≠a, hogar, belleza y m√°s.">
  
  <!-- Preconexiones optimizadas -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://ik.imagekit.io">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- PWA y favicon -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.jpg" type="image/x-icon" />

  <!-- Bootstrap e iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

  <!-- CSS optimizado -->
  <link rel="stylesheet" href="ESTILO.CSS?v=20251115" />
</head>

<body class="bg-light">
  <!-- Scripts optimizados -->
  <script src="app.js?v=20251115" defer></script>
  <script src="carrito.js?v=20251115" defer></script>
  <script src="buscador.js?v=20251115" type="module"></script>

  <!-- HEADER STICKY -->
  <div id="header-container" class="header-sticky"></div>

  <!-- BANNER PROMOCIONAL -->
  <div class="container-fluid banner-promocional py-2">
    <div class="container text-center">
      <small class="fw-bold">‚≠ê Los mejores precios ‚≠ê Calidad garantizada</small>
    </div>
  </div>

  <!-- BUSCADOR TIPO MERCADOLIBRE -->
  <div class="container mt-3">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8">
        <div class="position-relative">
          <input id="buscador" class="form-control buscador-ml" 
                 placeholder="Buscar productos, marcas y m√°s..." 
                 autocomplete="on">
          <div id="sugerencias" class="dropdown-menu position-absolute mt-1 w-100 z-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOT√ìN ATR√ÅS -->
  <div class="container mt-3">
    <a href="javascript:history.back()" class="btn btn-outline-dark">
      <i class="bi bi-arrow-left"></i> Volver atr√°s
    </a>
  </div>

  <!-- BOT√ìN PROMOCIONES -->
  <div class="container text-center mt-3">
    <a href="PROMOS.HTML" class="btn btn-warning fw-bold px-4 py-2 rounded-pill">
      üéÅ Ofertas Especiales
    </a>
  </div>

  <!-- CONTENIDO PRINCIPAL - PRODUCTOS -->
  <main class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 fw-bold mb-0" id="titulo-productos">Productos</h1>
      <span class="badge bg-primary" id="contador-productos">0 productos</span>
    </div>
    
    <div id="grid-productos" class="grid-productos-ml">
      <!-- Los productos se cargan din√°micamente -->
      <div class="card-producto-ml skeleton" style="height: 320px;"></div>
      <div class="card-producto-ml skeleton" style="height: 320px;"></div>
      <div class="card-producto-ml skeleton" style="height: 320px;"></div>
      <div class="card-producto-ml skeleton" style="height: 320px;"></div>
      <div class="card-producto-ml skeleton" style="height: 320px;"></div>
      <div class="card-producto-ml skeleton" style="height: 320px;"></div>
    </div>
  </main>

  <!-- SECCI√ìN CATEGOR√çAS RELACIONADAS -->
  <section class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h4 fw-bold mb-0">‚ú® M√°s categor√≠as relacionadas</h2>
    </div>
    
    <div id="seccion-categorias" class="grid-productos-ml">
      <!-- Las categor√≠as se cargan din√°micamente -->
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
      <div class="card-producto-ml skeleton" style="height: 280px;"></div>
    </div>
  </section>

  <!-- CARRITO OFFCANVAS -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCarrito">
    <div class="offcanvas-header border-bottom">
      <h4 class="offcanvas-title fw-bold">üõí Tu Carrito</h4>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body" id="carrito-contenido">
      <div class="text-center text-muted py-4">
        <i class="bi bi-bag-x fs-1"></i>
        <p class="mt-2">Tu carrito est√° vac√≠o</p>
      </div>
    </div>
    <div class="offcanvas-footer p-3 border-top">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="fw-bold">Subtotal:</span>
        <span id="subtotal" class="fw-bold fs-5 text-primary">$0</span>
      </div>
      <button class="btn btn-gradient px-4 py-2 rounded-pill fw-bold" onclick="abrirFormularioPedido()">
      ‚ú® Continuar compra ‚ú®
      </button>
    </div>
  </div>

  <!-- BOT√ìN CARRITO FLOTANTE -->
  <a href="#" class="btn-carrito-flotante d-none d-md-flex" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
    <i class="bi bi-bag-heart fs-5"></i>
    <span id="contador-carrito" class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill" style="font-size: 0.7rem;">0</span>
  </a>

  <!-- FOOTER -->
  <div id="footer-container" class="mt-5"></div>

  <!-- BARRA INFERIOR MOBILE -->
  <nav class="navbar fixed-bottom bg-white border-top d-md-none py-2">
    <div class="container-fluid">
      <div class="d-flex justify-content-around w-100">
        <a href="INICIO.HTML" class="text-center text-decoration-none text-primary">
          <i class="bi bi-house-fill fs-5"></i>
          <div class="small">Inicio</div>
        </a>
        <a href="PROMOS.HTML" class="text-center text-decoration-none text-dark">
          <i class="bi bi-percent fs-5"></i>
          <div class="small">Ofertas</div>
        </a>
        <a href="#" class="text-center text-decoration-none position-relative"
           data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
          <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
               style="width: 50px; height: 50px; margin-top: -8px;">
            <i class="bi bi-bag-heart fs-5 text-white"></i>
          </div>
          <span id="contador-carrito-mobile" class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill" style="font-size: 0.6rem;">0</span>
          <div class="small mt-1">Carrito</div>
        </a>
        <!-- BOT√ìN WHATSAPP ACTUALIZADO -->
        <a href="https://wa.me/573006498710?text=¬°Hola!%20Me%20interesan%20sus%20productos%20de%20Anmago%20Store" 
           class="text-center text-decoration-none text-success"
           target="_blank">
          <i class="bi bi-whatsapp fs-5"></i>
          <div class="small">Chat</div>
        </a>
        <a href="modalformulario.html" class="text-center text-decoration-none text-dark">
          <i class="bi bi-person fs-5"></i>
          <div class="small">Cuenta</div>
        </a>
      </div>
    </div>
  </nav>

  <!-- SCRIPTS EXTERNOS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JAVASCRIPT ESPEC√çFICO DE PRODUCTOS -->
  <script type="module">
    import { activarBuscadorGlobal } from './buscador.js';

    // üéØ Obtener par√°metros desde URL
    function getParametrosDesdeURL() {
      const params = new URLSearchParams(window.location.search);
      return {
        tipo: params.get("tipo")?.trim(),
        subtipo: params.get("subtipo")?.trim(),
        categoria: params.get("categoria")?.trim()
      };
    }

    // üì• Cargar cat√°logo
    async function cargarCatalogo() {
      try {
        const url = "https://raw.githubusercontent.com/anmagoS/ANMAGOPWA/main/catalogo.json?v=" + Date.now();
        const respuesta = await fetch(url);
        const productos = await respuesta.json();
        window.catalogoGlobal = productos;
        renderProductosML(productos);
        renderizarCategoriasRelacionadasML(productos);
      } catch (error) {
        console.error("‚ùå Error cargando cat√°logo:", error);
        mostrarErrorProductos();
      }
    }

    // üé® Renderizar productos estilo MercadoLibre
    function renderProductosML(productos) {
      const { tipo, subtipo, categoria } = getParametrosDesdeURL();
      const contenedor = document.getElementById("grid-productos");
      
      if (!tipo || !subtipo || !categoria || !contenedor) {
        contenedor.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">Par√°metros incompletos.</p></div>';
        return;
      }

      // Actualizar t√≠tulo
      document.getElementById("titulo-productos").textContent = categoria;

      const productosFiltrados = productos.filter(p =>
        p.tipo?.trim().toUpperCase() === tipo.toUpperCase() &&
        p.subtipo?.trim().toUpperCase() === subtipo.toUpperCase() &&
        p.categoria?.trim().toUpperCase() === categoria.toUpperCase()
      );

      // Actualizar contador
      document.getElementById("contador-productos").textContent = `${productosFiltrados.length} productos`;

      if (productosFiltrados.length === 0) {
        contenedor.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="bi bi-search fs-1 text-muted"></i>
            <p class="text-muted mt-2">No se encontraron productos en esta categor√≠a</p>
            <a href="CATEGORIAS.HTML?tipo=${encodeURIComponent(tipo)}&subtipo=${encodeURIComponent(subtipo)}" 
               class="btn btn-outline-primary mt-2">
              Volver a categor√≠as
            </a>
          </div>
        `;
        return;
      }

      contenedor.innerHTML = productosFiltrados.map(p => {
        const precioFormateado = p.precio?.toLocaleString("es-CO") || "0";
        
        return `
          <div class="card-producto-ml" data-producto-id="${p.id}">
            <a href="producto.html?id=${p.id}" class="text-decoration-none">
              <img src="${p.imagen}" 
                   alt="${p.producto}" 
                   class="card-img-ml" 
                   loading="lazy"
                   onerror="this.src='https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg'">
              <div class="card-body-ml">
                <h3 class="nombre-producto-ml small text-dark mb-2" title="${p.producto}">
                  ${p.producto}
                </h3>
                <div class="precio-ml mb-2">$${precioFormateado}</div>
                <div class="d-grid">
                  <button class="btn btn-outline-primary btn-sm" 
                          onclick="event.preventDefault(); event.stopPropagation(); verProducto('${p.id}')">
                    <i class="bi bi-eye"></i> Ver detalles
                  </button>
                </div>
              </div>
            </a>
          </div>
        `;
      }).join('');

      console.log("‚úÖ Productos renderizados:", productosFiltrados.length);
    }

    // üé® Renderizar categor√≠as relacionadas
    function renderizarCategoriasRelacionadasML(productos) {
      const { tipo, subtipo, categoria: categoriaActual } = getParametrosDesdeURL();
      const contenedor = document.getElementById("seccion-categorias");
      
      if (!contenedor || !tipo || !subtipo) {
        contenedor.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No hay categor√≠as relacionadas.</p></div>';
        return;
      }

      const productosFiltrados = productos.filter(p =>
        p.tipo?.trim().toUpperCase() === tipo.toUpperCase() && 
        p.subtipo?.trim().toUpperCase() === subtipo.toUpperCase()
      );

      const categoriasUnicas = [...new Set(productosFiltrados.map(p => p.categoria?.trim().toUpperCase()).filter(Boolean))]
        .filter(cat => cat && cat !== categoriaActual?.toUpperCase())
        .slice(0, 6);

      if (categoriasUnicas.length === 0) {
        contenedor.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No hay otras categor√≠as disponibles.</p></div>';
        return;
      }

      contenedor.innerHTML = categoriasUnicas.map(categoriaKey => {
        const productoRef = productosFiltrados.find(p => 
          p.categoria?.trim().toUpperCase() === categoriaKey
        );
        const categoriaOriginal = productoRef?.categoria?.trim() || categoriaKey;
        const imagen = productoRef?.imagen || "https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg";
        
        return `
          <div class="card-producto-ml">
            <a href="PRODUCTOS.HTML?tipo=${encodeURIComponent(tipo)}&subtipo=${encodeURIComponent(subtipo)}&categoria=${encodeURIComponent(categoriaOriginal)}" class="text-decoration-none">
              <img src="${imagen}" 
                   alt="${categoriaOriginal}" 
                   class="card-img-ml" 
                   loading="lazy"
                   onerror="this.src='https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg'">
              <div class="card-body-ml">
                <h3 class="nombre-producto-ml small text-dark mb-2">${categoriaOriginal}</h3>
                <div class="d-grid">
                  <span class="btn btn-outline-primary btn-sm">Explorar</span>
                </div>
              </div>
            </a>
          </div>
        `;
      }).join('');
    }

    // üëÅÔ∏è Ver producto
    function verProducto(productoId) {
      window.location.href = `producto.html?id=${productoId}`;
    }

    // ‚ùå Mostrar error
    function mostrarErrorProductos() {
      const contenedor = document.getElementById("grid-productos");
      if (contenedor) {
        contenedor.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="bi bi-emoji-frown fs-1 text-muted"></i>
            <p class="text-muted mt-2">No pudimos cargar los productos</p>
            <button class="btn btn-outline-primary mt-2" onclick="cargarCatalogo()">
              <i class="bi bi-arrow-clockwise"></i> Reintentar
            </button>
          </div>
        `;
      }
    }

    // üöÄ Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", async () => {
      // Cargar header
      try {
        const header = await fetch("HEADER.HTML").then(res => res.text());
        document.getElementById("header-container").innerHTML = header;
      } catch (error) {
        console.error("Error cargando header:", error);
      }

      // Cargar footer
      try {
        const footer = await fetch("footer.html").then(res => res.text());
        document.getElementById("footer-container").innerHTML = footer;
      } catch (error) {
        console.error("Error cargando footer:", error);
      }

      // Activar buscador
      activarBuscadorGlobal();

      // Cargar cat√°logo
      setTimeout(cargarCatalogo, 100);
    });

    // üåê Funciones globales
    window.verProducto = verProducto;
    window.cargarCatalogo = cargarCatalogo;
  </script>
<script>
// Sincronizaci√≥n de contadores para todas las p√°ginas
document.addEventListener('DOMContentLoaded', function() {
    // Si el carrito no est√° inicializado, inicializarlo
    if (!window.carritoManager) {
        console.log('üîÑ Inicializando carrito desde p√°gina secundaria');
        
        // Funci√≥n simple de inicializaci√≥n para p√°ginas secundarias
        const carritoGuardado = localStorage.getItem('carritoAnmago');
        const carrito = carritoGuardado ? JSON.parse(carritoGuardado) : [];
        const totalItems = carrito.reduce((total, item) => total + (item.cantidad || 1), 0);
        
        // Actualizar todos los contadores disponibles
        ['contador-carrito', 'contador-carrito-mobile', 'contador-carrito-header'].forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = totalItems;
                elemento.style.display = totalItems > 0 ? 'block' : 'none';
                console.log(`‚úÖ Contador ${id} actualizado:`, totalItems);
            }
        });
    }
    
    // Escuchar cambios en el localStorage entre pesta√±as
    window.addEventListener('storage', function(e) {
        if (e.key === 'carritoAnmago') {
            location.reload(); // Recargar para sincronizar
        }
    });
});
</script>
<script>
// DIAGN√ìSTICO DEL CARRITO - Agregar antes de </body>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîç INICIANDO DIAGN√ìSTICO DEL CARRITO...');
    
    // Verificar localStorage
    const carritoGuardado = localStorage.getItem('carritoAnmago');
    console.log('üì¶ Carrito en localStorage:', carritoGuardado);
    
    if (carritoGuardado) {
        try {
            const carrito = JSON.parse(carritoGuardado);
            console.log('üõí Productos en carrito:', carrito);
            console.log('üî¢ Total items:', carrito.reduce((sum, item) => sum + (item.cantidad || 1), 0));
            
            // Verificar estructura de datos
            carrito.forEach((item, index) => {
                console.log(`üìù Producto ${index + 1}:`, {
                    id: item.id,
                    nombre: item.nombre,
                    precio: item.precio,
                    cantidad: item.cantidad,
                    talla: item.talla,
                    imagen: item.imagen ? '‚úÖ' : '‚ùå'
                });
            });
            
        } catch (error) {
            console.error('‚ùå Error parseando carrito:', error);
        }
    } else {
        console.log('üì≠ Carrito vac√≠o en localStorage');
    }
    
    // Verificar si carritoManager est√° funcionando
    if (window.carritoManager) {
        console.log('‚úÖ carritoManager est√° inicializado');
        console.log('üõí carritoManager.articulosCarrito:', window.carritoManager.articulosCarrito);
    } else {
        console.log('‚ùå carritoManager NO est√° inicializado');
    }
});

// Funci√≥n para forzar actualizaci√≥n del offcanvas
function forzarActualizacionCarrito() {
    if (window.carritoManager && window.actualizarOffcanvasCarrito) {
        console.log('üîÑ Forzando actualizaci√≥n del offcanvas...');
        window.actualizarOffcanvasCarrito();
    }
}

// Actualizar offcanvas cuando se abra
document.addEventListener('DOMContentLoaded', function() {
    const offcanvasElement = document.getElementById('offcanvasCarrito');
    if (offcanvasElement) {
        offcanvasElement.addEventListener('show.bs.offcanvas', function() {
            console.log('üéØ Offcanvas abierto - actualizando contenido...');
            setTimeout(forzarActualizacionCarrito, 100);
        });
    }
});
</script>
</body>
</html>
