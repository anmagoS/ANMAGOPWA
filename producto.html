<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producto | Anmago Store</title>
  <link rel="icon" href="logo.jpg" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://ik.imagekit.io/mbsk9dati/CODIGOS/ESTILO.CSS">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div id="header-container"></div>

  <a href="#" class="btn btn_shopping" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
    <i class="bi bi-bag-heart"></i>
    <span id="contador-carrito" class="contador-carrito">0</span>
  </a>

  <main class="vista-producto container mt-4">
    <a href="javascript:history.back()" class="btn btn-outline-dark mb-3">
      <i class="bi bi-arrow-left"></i> Atr√°s
    </a>
    <h1 id="nombre" class="titulo-categoria">Cargando...</h1>
    <p class="precio" id="precio"></p>
    <p id="descripcion-corta" class="descripcion-corta text-muted fst-italic mt-2"></p>
    <div id="video-producto" class="video-producto video-wrapper mb-3"></div>
    <div id="galeria" class="grid-productos mb-3"></div>

    <div class="mb-3">
      <label for="tallaSeleccionada" class="form-label">Selecciona tu talla</label>
      <select id="tallaSeleccionada" class="form-select">
        <option value="">Selecciona una talla</option>
      </select>
    </div>
    <button id="btnAgregarCarrito" class="btn btn-primary w-100 mb-3">Agregar al carrito</button>
  </main>

  <section class="contenedor-categoria mt-5">
    <h2 class="titulo-categoria text-center">Variantes del mismo subtipo</h2>
    <div id="variantes-subtipo" class="grid-productos"></div>
  </section>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCarrito">
    <div class="offcanvas-header border-bottom">
      <h4 class="offcanvas-title text-center">Carrito de compras</h4>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body border-bottom" id="carrito-contenido"></div>
    <div class="offcanvas-footer mt-4">
      <h5 class="justify-content-between mb-2">
        <span class="fw-bold px-3">SUBTOTAL:</span>
        <span id="subtotal" class="fw-bold float-end px-2 fs-2">$0.00</span>
      </h5>
      <div class="text-center mt-3">
        <button class="btn btn-success w-100" id="btn-comprar">Comprar</button>
      </div>
    </div>
  </div>

  <div id="footer-container"></div>

  <div class="modal fade" id="zoomModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-transparent border-0">
        <div class="modal-body text-center">
          <img id="zoomImagen" src="" class="img-fluid rounded shadow" alt="Zoom" />
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalFormularioCliente" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Datos del cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="formCliente">
            <div class="mb-3">
              <label for="nombreCliente" class="form-label">Nombre</label>
              <input type="text" class="form-control" id="nombreCliente" required>
            </div>
            <div class="mb-3">
              <label for="telefonoCliente" class="form-label">Tel√©fono</label>
              <input type="tel" class="form-control" id="telefonoCliente" required>
            </div>
            <div class="mb-3">
              <label for="direccionCliente" class="form-label">Direcci√≥n</label>
              <input type="text" class="form-control" id="direccionCliente" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="btnEnviarPedido" class="btn btn-gradient" disabled>Enviar pedido</button>
        </div>
      </div>
    </div>
  </div>
  <script src="catalogo.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      const producto = catalogo.find(p => p.id === id);

      if (!producto) {
        document.getElementById("nombre").textContent = "Producto no encontrado";
        return;
      }

      // Renderizar producto
      document.getElementById("nombre").textContent = producto.producto;
      document.getElementById("precio").textContent = `$${producto.precio.toLocaleString("es-CO")}`;
      document.getElementById("descripcion-corta").textContent = producto.descripcion || "";

      // Galer√≠a
      const galeria = document.getElementById("galeria");
      const imagenes = producto.url?.split("[]") || [];
      galeria.innerHTML = imagenes.map(src => `
        <img src="${src}" class="img-fluid rounded shadow m-2" style="max-width:300px;cursor:zoom-in;" onclick="mostrarZoom('${src}')">
      `).join("");

      // Video
      const video = document.getElementById("video-producto");
      if (producto.video_url?.includes("youtube")) {
        const videoId = producto.video_url.split("v=")[1]?.split("&")[0];
        video.innerHTML = `
          <div class="ratio ratio-16x9">
            <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
          </div>
        `;
      }

      // Tallas
      const selectTalla = document.getElementById("tallaSeleccionada");
      const tallas = producto.tallas?.split(",").map(t => t.trim()) || [];
      tallas.forEach(talla => {
        const option = document.createElement("option");
        option.value = talla;
        option.textContent = talla;
        selectTalla.appendChild(option);
      });

      // Variantes del mismo subtipo
      const variantes = catalogo.filter(p => p.subtipo === producto.subtipo && p.id !== producto.id);
      const contenedor = document.getElementById("variantes-subtipo");
      contenedor.innerHTML = variantes.map(p => {
        const img = p.url?.split("[]")[0] || "REDES_IMAGES/default.jpg";
        return `
          <div class="producto">
            <a href="producto.html?id=${p.id}" class="imagen-producto">
              <img src="${img}" alt="${p.producto}">
            </a>
            <div class="nombre-producto">${p.producto}</div>
            <div class="precio-producto">$${p.precio.toLocaleString("es-CO")}</div>
          </div>
        `;
      }).join("");
    });

    function mostrarZoom(src) {
      const modal = new bootstrap.Modal(document.getElementById("zoomModal"));
      document.getElementById("zoomImagen").src = src;
      modal.show();
    }

    document.addEventListener("click", e => {
      if (e.target.id === "btnAgregarCarrito") {
        const talla = document.getElementById("tallaSeleccionada").value;
        if (!talla) {
          alert("Selecciona una talla antes de agregar al carrito.");
          return;
        }
        const id = new URLSearchParams(window.location.search).get("id");
        const producto = catalogo.find(p => p.id === id);
        const productoConTalla = { ...producto, tallaSeleccionada: talla };
        agregarAlCarrito(productoConTalla);
      }

      if (e.target.id === "btn-comprar") {
        const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById("modalFormularioCliente"));
        modal.show();
      }
    });

    document.getElementById("formCliente").addEventListener("input", () => {
      const nombre = document.getElementById("nombreCliente").value.trim();
      const tel = document.getElementById("telefonoCliente").value.trim();
      const dir = document.getElementById("direccionCliente").value.trim();
      const btn = document.getElementById("btnEnviarPedido");
      btn.disabled = !(nombre && tel && dir);
    });

    document.getElementById("btnEnviarPedido").addEventListener("click", () => {
      const nombre = document.getElementById("nombreCliente").value.trim();
      const tel = document.getElementById("telefonoCliente").value.trim();
      const dir = document.getElementById("direccionCliente").value.trim();
      const carrito = JSON.parse(localStorage.getItem("carrito") || "[]");

      const resumen = carrito.map(p => `üõçÔ∏è ${p.producto} (${p.tallaSeleccionada || "sin talla"}) - $${p.precio.toLocaleString("es-CO")}`).join("\n");
      const total = carrito.reduce((s, p) => s + Number(p.precio), 0);
      const mensaje = `üì¶ Pedido ANMAGO\nüë§ ${nombre}\nüìû ${tel}\nüìç ${dir}\n\n${resumen}\n\nüí∞ Total: $${total.toLocaleString("es-CO")}`;

      // WhatsApp
      const urlWA = `https://wa.me/57XXXXXXXXXX?text=${encodeURIComponent(mensaje)}`;
      window.open(urlWA, "_blank");

      // Telegram (estructura lista para conectar)
      fetch("https://api.telegram.org/bot<token>/sendMessage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: "<chat_id>", text: mensaje })
      });

      // Google Sheets (estructura lista para conectar)
      fetch("https://script.google.com/macros/s/<ID>/exec", {
        method: "POST",
        body: new FormData(document.getElementById("formCliente"))
      });

      alert("Pedido enviado. Gracias por tu compra.");
      localStorage.removeItem("carrito");
      location.reload();
    });
  </script>
</body>
</html>
