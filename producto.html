<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle del Producto | Anmago Store - Los Mejores Precios</title>
  <meta name="description" content="Descubre los detalles de nuestro producto. Calidad garantizada y los mejores precios en Anmago Store.">
  
  <!-- Preconexiones optimizadas -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://ik.imagekit.io">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- PWA y favicon -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.jpg" type="image/x-icon" />

  <!-- Bootstrap e iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

  <!-- CSS optimizado -->
  <link rel="stylesheet" href="ESTILO.CSS?v=20251115" />
</head>

<body class="bg-light">
  <!-- Scripts optimizados -->
  <script src="app.js?v=20251115" defer></script>
  <script src="carrito.js?v=20251115" defer></script>
  <script src="buscador.js?v=20251115" type="module"></script>

  <!-- HEADER STICKY -->
  <div id="header-container" class="header-sticky"></div>

  <!-- BANNER PROMOCIONAL -->
  <div class="container-fluid banner-promocional py-2">
    <div class="container text-center">
      <small class="fw-bold">‚≠ê Los mejores precios ‚≠ê Calidad garantizada</small>
    </div>
  </div>

  <!-- BUSCADOR TIPO MERCADOLIBRE -->
  <div class="container mt-3">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8">
        <div class="position-relative">
          <input id="buscador" class="form-control buscador-ml" 
                 placeholder="Buscar productos, marcas y m√°s..." 
                 autocomplete="on">
          <div id="sugerencias" class="dropdown-menu position-absolute mt-1 w-100 z-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOT√ìN ATR√ÅS -->
  <div class="container mt-3">
    <a href="javascript:history.back()" class="btn btn-outline-dark">
      <i class="bi bi-arrow-left"></i> Volver atr√°s
    </a>
  </div>

  <!-- BOT√ìN PROMOCIONES -->
  <div class="container text-center mt-3">
    <a href="PROMOS.HTML" class="btn btn-warning fw-bold px-4 py-2 rounded-pill">
      üéÅ Ofertas Especiales
    </a>
  </div>

  <!-- CONTENIDO PRINCIPAL - DETALLE PRODUCTO -->
  <main class="container mt-4">
    <!-- Informaci√≥n principal del producto -->
    <div class="text-center mb-4">
      <h1 id="nombre" class="h3 fw-bold mb-2">Cargando producto...</h1>
      <div id="precio" class="precio-ml fs-2 mb-3"></div>
      <div id="descripcion-corta"></div>
    </div>

    <!-- Video del producto -->
    <div id="video-producto" class="mb-4"></div>

    <!-- Galer√≠a de im√°genes -->
    <div class="mb-4">
      <h3 class="h5 fw-bold mb-3">üñºÔ∏è Galer√≠a del producto</h3>
      <div id="galeria" class="grid-productos-ml"></div>
    </div>

    <!-- Descripci√≥n completa -->
    <div id="descripcion-completa" class="mt-4"></div>
  </main>

  <!-- CARRITO OFFCANVAS -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCarrito">
    <div class="offcanvas-header border-bottom">
      <h4 class="offcanvas-title fw-bold">üõí Tu Carrito</h4>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body" id="carrito-contenido">
      <div class="text-center text-muted py-4">
        <i class="bi bi-bag-x fs-1"></i>
        <p class="mt-2">Tu carrito est√° vac√≠o</p>
      </div>
    </div>
    <div class="offcanvas-footer p-3 border-top">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="fw-bold">Subtotal:</span>
        <span id="subtotal" class="fw-bold fs-5 text-primary">$0</span>
      </div>
      <button class="btn btn-outline-primary btn-sm" onclick="abrirFormularioPedido()">
        Continuar compra
      </button>
    </div>
  </div>

  <!-- MODAL M√ìVIL PARA AGREGAR AL CARRITO -->
  <div class="modal-mobile-backdrop" id="modalMobileBackdrop"></div>
  <div class="modal-mobile-bottom" id="modalMobile">
    <div class="modal-mobile-content">
      <div class="text-center">
        <i class="bi bi-check-circle-fill text-success fs-1"></i>
        <h5 class="fw-bold mt-2">¬°Producto agregado!</h5>
        <p class="text-muted">Tu producto fue agregado al carrito con √©xito</p>
        
        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-primary" onclick="irAlCarrito()">
            <i class="bi bi-bag-check"></i> Ir al carrito
          </button>
          <button class="btn btn-outline-primary" onclick="seguirComprando()">
            <i class="bi bi-cart-plus"></i> Seguir comprando
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL ZOOM IMAGEN -->
  <div class="modal fade" id="zoomModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-transparent border-0">
        <div class="modal-body text-center p-0">
          <img id="zoomImagen" src="" class="img-fluid rounded shadow" alt="Zoom" />
        </div>
      </div>
    </div>
  </div>

  <!-- BOT√ìN CARRITO FLOTANTE -->
  <a href="#" class="btn-carrito-flotante d-none d-md-flex" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
    <i class="bi bi-bag-heart fs-5"></i>
    <span id="contador-carrito" class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill" style="font-size: 0.7rem;">0</span>
  </a>

  <!-- FOOTER -->
  <div id="footer-container" class="mt-5"></div>

  <!-- BARRA INFERIOR MOBILE -->
  <nav class="navbar fixed-bottom bg-white border-top d-md-none py-2">
    <div class="container-fluid">
      <div class="d-flex justify-content-around w-100">
        <a href="INICIO.HTML" class="text-center text-decoration-none text-primary">
          <i class="bi bi-house-fill fs-5"></i>
          <div class="small">Inicio</div>
        </a>
        <a href="PROMOS.HTML" class="text-center text-decoration-none text-dark">
          <i class="bi bi-percent fs-5"></i>
          <div class="small">Ofertas</div>
        </a>
        <a href="#" class="text-center text-decoration-none position-relative"
           data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
          <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
               style="width: 50px; height: 50px; margin-top: -8px;">
            <i class="bi bi-bag-heart fs-5 text-white"></i>
          </div>
          <span id="contador-carrito-mobile" class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill" style="font-size: 0.6rem;">0</span>
          <div class="small mt-1">Carrito</div>
        </a>
        <!-- BOT√ìN WHATSAPP ACTUALIZADO -->
        <a href="https://wa.me/573006498710?text=¬°Hola!%20Me%20interesan%20sus%20productos%20de%20Anmago%20Store" 
           class="text-center text-decoration-none text-success"
           target="_blank">
          <i class="bi bi-whatsapp fs-5"></i>
          <div class="small">Chat</div>
        </a>
        <a href="modalformulario.html" class="text-center text-decoration-none text-dark">
          <i class="bi bi-person fs-5"></i>
          <div class="small">Cuenta</div>
        </a>
      </div>
    </div>
  </nav>

  <!-- SCRIPTS EXTERNOS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- JAVASCRIPT ESPEC√çFICO DE PRODUCTO -->
  <script type="module">
    import { activarBuscadorGlobal } from './buscador.js';

    // üéØ Funciones del modal m√≥vil
    function mostrarModalMobile() {
      if (window.innerWidth <= 768) {
        document.getElementById('modalMobile').classList.add('show');
        document.getElementById('modalMobileBackdrop').classList.add('show');
      }
    }

    function ocultarModalMobile() {
      document.getElementById('modalMobile').classList.remove('show');
      document.getElementById('modalMobileBackdrop').classList.remove('show');
    }

    function irAlCarrito() {
      const offcanvas = document.getElementById("offcanvasCarrito");
      if (offcanvas) {
        const instancia = bootstrap.Offcanvas.getOrCreateInstance(offcanvas);
        instancia.show();
      }
      ocultarModalMobile();
    }

    function seguirComprando() {
      window.location.href = "INICIO.HTML";
    }

    // üéØ Validar selectores de talla y variables
    function crearSelectorHTML(tallas, variantes) {
      let selectorHTML = "";
      
      // Validar tallas (excluir "N/A" y "√∫nica")
      const tallasValidas = tallas?.filter(t => {
        const tLower = t.trim().toLowerCase();
        return t && t.trim() !== "" && 
               tLower !== "n/a" && 
               tLower !== "√∫nica" &&
               tLower !== "unica";
      }) || [];
      
      // Validar variantes
      const variantesValidas = variantes?.filter(v => 
        v && v.trim() !== ""
      ) || [];

      if (tallasValidas.length > 0) {
        selectorHTML = `
          <label class="form-label mt-2 fw-bold">üìè Talla:</label>
          <select class="form-select mb-2 selector-talla">
            ${tallasValidas.map(t => `<option value="${t.trim()}">${t.trim()}</option>`).join("")}
          </select>
        `;
      } else if (variantesValidas.length > 0) {
        selectorHTML = `
          <label class="form-label mt-2 fw-bold">üé® Variante:</label>
          <select class="form-select mb-2 selector-variable">
            ${variantesValidas.map(v => `<option value="${v.trim()}">${v.trim()}</option>`).join("")}
          </select>
        `;
      }
      
      return selectorHTML;
    }

    // üì• Cargar producto
    async function cargarProducto() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      
      try {
        const url = "https://raw.githubusercontent.com/anmagoS/ANMAGOPWA/main/catalogo.json?v=" + Date.now();
        const res = await fetch(url);
        const productos = await res.json();
        const producto = productos.find(p => p.id === id);
        
        if (!producto) {
          document.getElementById("nombre").textContent = "Producto no encontrado";
          return;
        }

        // Informaci√≥n b√°sica
        document.getElementById("nombre").textContent = producto.producto;
        document.getElementById("precio").textContent = `$${producto.precio?.toLocaleString("es-CO") || "0"}`;
        
        // Frase institucional
        const fraseInferior = `
          <div class="alert alert-light border mt-3">
            <p class="mb-0 text-center text-dark">
              Presentamos <strong>${producto.producto}</strong> 
              ${producto.tallas && producto.tallas !== "N/A" && producto.tallas.toLowerCase() !== "√∫nica" && producto.tallas.toLowerCase() !== "unica" ? `en tallas <strong>${producto.tallas}</strong>,` : ""}
              elaborado en <strong>${producto.material || "material premium"}</strong>,
              con calidad garantizada. Solo en <strong class="text-dark">ANMAGO STORE</strong>.
            </p>
          </div>
        `;
        document.getElementById("descripcion-corta").innerHTML = fraseInferior;

        // Video desde video_url (solo YouTube)
        const contenedorVideo = document.getElementById("video-producto");
        contenedorVideo.innerHTML = "";

        if (producto.video_url?.includes("youtube.com/shorts/")) {
          const videoID = producto.video_url.split("/shorts/")[1]?.split(/[?&]/)[0];
          if (videoID?.length === 11) {
            contenedorVideo.innerHTML = `
              <div class="ratio ratio-16x9">
                <iframe src="https://www.youtube.com/embed/${videoID}?rel=0"
                  title="Video del producto" allowfullscreen
                  class="rounded shadow" loading="lazy"></iframe>
              </div>
            `;
          }
        } else if (producto.video_url?.includes("youtube.com/watch?v=")) {
          const videoID = producto.video_url.split("watch?v=")[1]?.split(/[?&]/)[0];
          if (videoID?.length === 11) {
            contenedorVideo.innerHTML = `
              <div class="ratio ratio-16x9">
                <iframe src="https://www.youtube.com/embed/${videoID}?rel=0"
                  title="Video del producto" allowfullscreen
                  class="rounded shadow" loading="lazy"></iframe>
              </div>
            `;
          }
        }

        // GALER√çA
        const galeria = document.getElementById("galeria");
        const imagenes = producto.url?.split("[]").map(u => u.trim()).filter(Boolean) || [];
        const tallas = producto.tallas?.split(",").map(t => t.trim()) || [];
        const variantes = producto.variables?.split(",").map(v => v.trim()) || [];

        if (imagenes.length === 0) {
          galeria.innerHTML = `
            <div class="col-12 text-center py-4">
              <i class="bi bi-image text-muted fs-1"></i>
              <p class="text-muted mt-2">No hay im√°genes disponibles</p>
            </div>
          `;
          return;
        }

        imagenes.forEach((img, i) => {
          const tarjeta = document.createElement("div");
          tarjeta.className = "card-producto-ml";

          // Crear selector solo si hay opciones v√°lidas
          const selectorHTML = crearSelectorHTML(tallas, variantes);

          tarjeta.innerHTML = `
            <div class="position-relative">
              <img src="${img}" 
                   alt="${producto.producto} - Variante ${i + 1}" 
                   class="card-img-ml zoomable" 
                   style="cursor: zoom-in;"
                   loading="lazy"
                   onerror="this.src='https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg'">
            </div>
            <div class="card-body-ml">
              ${selectorHTML}
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-cart-plus"></i> Agregar al carrito
              </button>
            </div>
          `;

          const boton = tarjeta.querySelector("button");
          const selectorTalla = tarjeta.querySelector(".selector-talla");
          const selectorVariable = tarjeta.querySelector(".selector-variable");

          boton.addEventListener("click", () => {
            let varianteSeleccionada = "No especificada";
            if (selectorTalla) varianteSeleccionada = selectorTalla.value;
            else if (selectorVariable) varianteSeleccionada = selectorVariable.value;

            const productoFinal = {
              id: producto.id + "-" + i + "-" + varianteSeleccionada,
              nombre: producto.producto,
              precio: producto.precio,
              imagen: img,
              talla: varianteSeleccionada,
              cantidad: 1,
              proveedor: producto.proveedor || "Anmago Store"
            };

            if (window.carritoManager) {
              window.carritoManager.agregarProducto(productoFinal);
              mostrarModalMobile();
            }
          });

          galeria.appendChild(tarjeta);
        });

        // Descripci√≥n completa
        if (producto.descripcion) {
          document.getElementById("descripcion-completa").innerHTML = `
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">üìù Descripci√≥n completa</h4>
                <p class="card-text">${producto.descripcion.replace(/\n/g, "<br>")}</p>
              </div>
            </div>
          `;
        }

      } catch (error) {
        console.error("‚ùå Error cargando producto:", error);
        document.getElementById("nombre").textContent = "Error al cargar el producto";
      }
    }

    // üöÄ Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", async () => {
      // Cargar header
      try {
        const header = await fetch("HEADER.HTML").then(res => res.text());
        document.getElementById("header-container").innerHTML = header;
      } catch (error) {
        console.error("Error cargando header:", error);
      }

      // Cargar footer
      try {
        const footer = await fetch("footer.html").then(res => res.text());
        document.getElementById("footer-container").innerHTML = footer;
      } catch (error) {
        console.error("Error cargando footer:", error);
      }

      // Activar buscador
      activarBuscadorGlobal();

      // Cargar producto
      setTimeout(cargarProducto, 100);

      // Evento para cerrar modal al tocar fuera
      document.getElementById('modalMobileBackdrop').addEventListener('click', ocultarModalMobile);

      // Evento para zoom de im√°genes
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("zoomable")) {
          const src = e.target.getAttribute("src");
          document.getElementById("zoomImagen").setAttribute("src", src);
          const modal = new bootstrap.Modal(document.getElementById("zoomModal"));
          modal.show();
        }
      });
    });

    // üåê Funciones globales
    window.abrirFormularioPedido = function() {
      window.open('modalformulario.html', '_blank');
    };

    window.irAlCarrito = irAlCarrito;
    window.seguirComprando = seguirComprando;
    window.ocultarModalMobile = ocultarModalMobile;
  </script>
</body>
</html>
