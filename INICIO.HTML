<!-- INICIALIZACI√ìN -->
<script type="module">
  import { activarBuscadorGlobal } from './buscador.js';

  const imagenesPorTipo = {
    "ROPA": "https://ik.imagekit.io/mbsk9dati/593678a2-9af5-47a8-a47c-34407d25bd60.jpg?updatedAt=1758216950422",
    "RELOJERIA": "https://ik.imagekit.io/mbsk9dati/producto_53/PRODUCTOS_Images_d9594fb8.IMAGEN_12.215521.jpg?updatedAt=1757714222484",
    "HOGAR": "portad1-1.webp",
    "BELLEZA": "R.jpg",
    "ESCOLAR": "fondo-vuelta-al-cole-elementos_23-2147848492.jpg"
  };

  async function cargarCatalogo() {
    const url = "https://raw.githubusercontent.com/anmagoS/CATALOGO-SPA/main/catalogo.json";
    const respuesta = await fetch(url);
    const productos = await respuesta.json();
    window.catalogoGlobal = productos;
    renderTipos(productos);
    renderCarruselPromosDesdePromos(window.catalogoGlobal);    
  }

  function renderTipos(productos) {
    const contenedor = document.getElementById("grid-tipos");
    contenedor.innerHTML = "";

    const tiposUnicos = [...new Set(productos.map(p => p.tipo?.trim()).filter(Boolean))];

    tiposUnicos.forEach(tipo => {
      const imagenRef = imagenesPorTipo[tipo] || "imagen-default.jpg";
      const tarjeta = document.createElement("div");
      tarjeta.className = "producto";
      tarjeta.innerHTML = `
        <a href="SUBTIPOS.HTML?tipo=${encodeURIComponent(tipo)}" class="imagen-producto">
          <img src="${imagenRef}" alt="${tipo}">
        </a>
        <div class="nombre-producto">${tipo}</div>
        <a class="boton-comprar" href="SUBTIPOS.HTML?tipo=${encodeURIComponent(tipo)}">Ver m√°s</a>
      `;
      contenedor.appendChild(tarjeta);
    });
  }

  function ajustarCarrito() {
    const header = document.querySelector(".header");
    const carritoBtn = document.querySelector(".btn_shopping");
    if (header && carritoBtn) {
      const alturaHeader = header.offsetHeight;
      carritoBtn.style.top = `${alturaHeader + 12}px`;
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const header = await fetch("HEADER.HTML").then(res => res.text());
    document.getElementById("header-container").insertAdjacentHTML("afterbegin", header);
    await new Promise(resolve => requestAnimationFrame(resolve));
    ajustarCarrito();
    await new Promise(resolve => requestAnimationFrame(resolve));
    ajustarCarrito();

    const carritoBtn = document.querySelector(".btn_shopping");
    carritoBtn?.addEventListener("click", e => {
      e.preventDefault();
      const offcanvas = document.getElementById("offcanvasCarrito");
      if (offcanvas) {
        const instancia = bootstrap.Offcanvas.getOrCreateInstance(offcanvas);
        instancia.show();
      }
    });

    activarBuscadorGlobal();

    // üîî Alerta de instalaci√≥n PWA
    let deferredPrompt;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;

      const deseaInstalar = window.confirm("¬°Descarga nuestra app y disfruta de excelentes productos y promociones!");

      if (deseaInstalar && deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === "accepted") {
            console.log("‚úÖ App instalada");
          } else {
            console.log("‚ùå Instalaci√≥n cancelada");
          }
          deferredPrompt = null;
        });
      }
    });

    const footer = await fetch("footer.html").then(res => res.text());
    document.getElementById("footer-container").innerHTML = footer;

    await cargarCatalogo();
  });
</script>
