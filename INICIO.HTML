<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inicio | Anmago Store</title>
  <!-- üîó Preconexi√≥n para acelerar carga -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://ik.imagekit.io">
  <!-- üé® CSS institucional con carga diferida (opcional) -->
<link rel="stylesheet" href="https://ik.imagekit.io/mbsk9dati/CODIGOS/ESTILO.CSS?updatedAt=1761584337045" media="print" onload="this.media='all'">
<!-- üì¶ Bootstrap y √≠conos con carga diferida -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" media="print" onload="this.media='all'" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" media="print" onload="this.media='all'" />
<!-- üì± PWA y favicon -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://ik.imagekit.io/mbsk9dati/logo.jpg?tr=w-560,q-80" type="image/x-icon" />
</head>

<body>
  <!-- HEADER -->
  <div id="header-container"></div>
  <!-- BUSCADOR MODULAR -->
  <div class="container mt-0 position-relative" style="max-width: 600px;">
    <input id="buscador" class="form-control" placeholder="Buscar productos, categor√≠as, precios..." autocomplete="on">
    <div id="sugerencias" class="dropdown-menu position-absolute mt-0 w-100 z-3"></div>
  </div>

  <!-- BOT√ìN FLOTANTE DEL CARRITO -->
  <a href="#" class="btn btn_shopping" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
    <i class="bi bi-bag-heart"></i>
    <span id="contador-carrito" class="contador-carrito">0</span>
  </a>
  <!-- BOT√ìN DE INSTALACI√ìN PWA -->
  <div id="instalar-container" class="bloque-superior-pwa d-none">
    <button id="boton-instalar" class="btn btn-gradient fw-bold d-flex align-items-center justify-content-center mx-auto" style="gap: 12px; padding: 12px 24px; border-radius: 8px; font-size: 1.1rem;">
      <img src="tina-192.png" alt="Instalar" style="width: 32px; height: 32px;" />
      Instalar Anmago Store
    </button>
  </div>
  <!-- CONTENIDO PRINCIPAL -->
  <main class="contenedor-categoria">
    <h1 class="titulo-categoria text-center">Colecciones</h1>
    <div id="grid-tipos" class="grid-productos"></div>

    <div class="container-fluid text-center mt-3 px-3">
      <a href="PROMOS.HTML" class="btn btn-gradient fw-bold">üéÅ Ver promociones exclusivas</a>
    </div>
    <div id="temporizador-promos" class="text-center text-muted mt-2 small"></div>
    <div id="carouselPromos" class="carousel slide mt-4" data-bs-ride="carousel">
      <div class="carousel-inner" id="carousel-promos-contenido"></div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselPromos" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselPromos" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
    <!-- Secciones institucionales -->
    <section class="seccion-centrada">
  <h2 class="titulo-categoria">üé• Conoce m√°s sobre <span class="text-gradient">Anmago Store</span></h2>
  <div class="video-wrapper mt-3">
    <div class="card mx-auto shadow" style="max-width: 560px; border-radius: 12px; overflow: hidden; cursor: pointer;" onclick="cargarVideo()">
      <img src="https://ik.imagekit.io/mbsk9dati/logo.jpg?tr=w-560,q-80" alt="Video Anmago Store" fetchpriority="high" width="560" height="315" decoding="async"
 class="img-fluid">
      <div class="card-body bg-light text-center py-2">
        <i class="bi bi-play-circle-fill fs-1 text-primary"></i>
        <p class="mb-0 fw-bold">Haz clic para ver el video</p>
      </div>
    </div>
  </div>
</section>

<script>
  function cargarVideo() {
    document.querySelector('.video-wrapper').innerHTML = `
      <iframe width="100%" height="315" src="https://www.youtube.com/embed/E8_rkF1957Y" title="Video de presentaci√≥n" frameborder="0" allowfullscreen style="max-width: 560px; border-radius: 12px;"></iframe>
    `;
  }
</script>

    <section class="seccion-centrada">
      <h2 class="titulo-categoria">Aliados</h2>
      <a class="boton-comprar" href="https://sites.google.com/view/anmagostore/aliados" target="_blank">Cat√°logos Aliados</a>
    </section>

    <section class="seccion-centrada">
      <p class="frase-destacada">‚ÄúLa ropa no solo cubre tu cuerpo, sino que tambi√©n expresa tu alma. En cada prenda, encuentras confianza, elegancia y la magia de ser t√∫ mismo‚Äù</p>
      <p class="frase-secundaria">¬°Disfruta la experiencia de vestir tus sue√±os en Anmago Store!</p>
      <a class="boton-comprar" href="https://docs.google.com/forms/d/e/1FAIpQLSevvlCBgz7L6l2-DecKQLazoswqzf7DRYWOaCq4FtMGOR6D2Q/viewform?usp=header" target="_blank">Deja tus datos</a>
    </section>
  </main>

  <!-- CARRITO OFFCANVAS -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCarrito">
    <div class="offcanvas-header border-bottom">
      <h4 class="offcanvas-title text-center">Carrito de compras</h4>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body border-bottom" id="carrito-contenido"></div>
    <div class="offcanvas-footer mt-4">
      <h5 class="justify-content-between mb-2">
        <span class="fw-bold px-3">SUBTOTAL:</span>
        <span id="subtotal" class="fw-bold float-end px-2 fs-2">$0.00</span>
      </h5>
    </div>
  </div>

  <!-- FOOTER -->
  <div id="footer-container"></div>

  <!-- SCRIPTS EXTERNOS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="carrito.js"></script>
  <script src="app.js"></script>
  <script src="buscador.js" type="module"></script>

  <!-- üîß Limpieza de par√°metros Facebook -->
  <script>
    if (window.location.search.includes("fbclid")) {
      const cleanURL = window.location.origin + window.location.pathname;
      window.location.replace(cleanURL);
    }
  </script>

  <!-- INICIALIZACI√ìN -->
<script type="module">
  import { activarBuscadorGlobal } from './buscador.js';

  const imagenesPorTipo = {
    "ROPA": "https://ik.imagekit.io/mbsk9dati/593678a2-9af5-47a8-a47c-34407d25bd60.jpg?tr=w-600,q-80",
    "RELOJERIA": "https://ik.imagekit.io/mbsk9dati/producto_53/PRODUCTOS_Images_d9594fb8.IMAGEN_12.215521.jpg?tr=w-140,h-152,q-80",
    "HOGAR": "https://ik.imagekit.io/mbsk9dati/portad1-1.webp?tr=w-140,h-152,q-80",
    "BELLEZA": "https://ik.imagekit.io/mbsk9dati/R.jpg?tr=w-140,h-152,q-80",
    "ESCOLAR": "fondo-vuelta-al-cole-elementos_23-2147848492.jpg",
    "NAVIDAD": "https://ik.imagekit.io/mbsk9dati/4-im%C3%A1genes-navide%C3%B1as-christmas-pictures-postales-de-Navidad-Joyeux-Noel-Bon-Nadal-Merry-Christmas%20(2).png?tr=w-140,h-152,q-80"  };
  

  function obtenerIndicePromocional(totalPromos = 0, cantidadPorCiclo = 4, ciclosPorDia = 4) {
    const ahora = new Date();
    const inicio = new Date("2025-11-08T00:00:00");
    const diferenciaHoras = Math.floor((ahora - inicio) / (1000 * 60 * 60));
    const cicloActual = diferenciaHoras % (ciclosPorDia * 365);
    const indice = cicloActual * cantidadPorCiclo;
    return totalPromos > 0 ? indice % totalPromos : 0;
  }

  function renderTipos(productos) {
    const contenedor = document.getElementById("grid-tipos");
    contenedor.innerHTML = "";

    const tiposUnicos = [...new Set(productos.map(p => p.tipo?.trim()).filter(Boolean))];

    tiposUnicos.forEach(tipo => {
      const imagenRef = imagenesPorTipo[tipo] || "imagen-default.jpg";
      const tarjeta = document.createElement("div");
      tarjeta.className = "producto";
      tarjeta.innerHTML = `
        <a href="SUBTIPOS.HTML?tipo=${encodeURIComponent(tipo)}" class="imagen-producto">
          <img src="${imagenRef}" alt="${tipo}" loading="lazy" width="140" height="152" decoding="async">
        </a>
        <div class="nombre-producto">${tipo}</div>
        <a class="boton-comprar" href="SUBTIPOS.HTML?tipo=${encodeURIComponent(tipo)}">Ver m√°s</a>
      `;
      contenedor.appendChild(tarjeta);
    });
  }

  function renderCarruselPromosDesdePromos(productos) {
    const contenedor = document.getElementById("carousel-promos-contenido");
    if (!contenedor) return;

    const promociones = productos.filter(p => {
      const promo = typeof p.promo === "string" ? p.promo.toLowerCase().trim() : p.promo;
      return promo === true || promo === "true" || promo === "s√≠" || promo === "activo";
    });

    const totalPromos = promociones.length;
    const indiceActual = obtenerIndicePromocional(totalPromos);
   let bloque = promociones.slice(indiceActual, indiceActual + 4);
if (bloque.length < 4 && promociones.length >= 4) {
  bloque = promociones.slice(0, 4); // fallback si el √≠ndice se desborda
    contenedor.innerHTML = "";

    bloque.forEach((p, index) => {
      const item = document.createElement("div");
      item.className = `carousel-item ${index === 0 ? "active" : ""}`;
      item.innerHTML = `
        <div class="d-flex justify-content-center">
          <div class="card" style="width: 18rem;">
            <img src="${p.imagen}" class="card-img-top" alt="${p.producto}" fetchpriority="${index === 0 ? 'high' : 'auto'}" width="288" height="288" decoding="async">
            <div class="card-body text-center">
              <h5 class="card-title">${p.producto}</h5>
              <p class="card-text">
                <s class="text-muted me-2">$${p.precio.toLocaleString("es-CO")}</s>
                <span class="text-success fw-bold">$${(p.precio * 0.9).toLocaleString("es-CO")}</span>
              </p>
              <a href="producto.html?id=${p.id}" class="boton-comprar">Ver producto</a>
            </div>
          </div>
        </div>
      `;
      contenedor.appendChild(item);
    });
  }

  function iniciarTemporizadorPromos() {
    const temporizador = document.getElementById("temporizador-promos");
    if (!temporizador) return;

    setInterval(() => {
      const ahora = new Date();
      const siguienteCorte = Math.ceil(ahora.getHours() / 6) * 6;
      const siguienteFecha = new Date(ahora);
      siguienteFecha.setHours(siguienteCorte, 0, 0, 0);

      const restante = siguienteFecha - ahora;
      if (restante <= 0) {
        temporizador.textContent = "‚è≥ ¬°Promociones actualizadas!";
        return;
      }

      const horas = Math.floor(restante / (1000 * 60 * 60));
      const minutos = Math.floor((restante % (1000 * 60 * 60)) / (1000 * 60));
      const segundos = Math.floor((restante % (1000 * 60)) / 1000);

      temporizador.textContent = `‚è∞ Cambia en ${horas}h ${minutos}m ${segundos}s`;
    }, 1000);
  }

  document.addEventListener("DOMContentLoaded", async () => {
    activarBuscadorGlobal();

    const url = "https://raw.githubusercontent.com/anmagoS/ANMAGOPWA/main/catalogo.json";
    const respuesta = await fetch(url);
    const productos = await respuesta.json();
    window.catalogoGlobal = productos;
    window.catalogo = productos;

    renderTipos(productos);
    renderCarruselPromosDesdePromos(productos);
    iniciarTemporizadorPromos();

    requestIdleCallback(async () => {
      const footer = await fetch("footer.html").then(res => res.text());
      document.getElementById("footer-container").innerHTML = footer;
    });

    const carritoBtn = document.querySelector(".btn_shopping");
    carritoBtn?.addEventListener("click", e => {
      e.preventDefault();
      const offcanvas = document.getElementById("offcanvasCarrito");
      if (offcanvas) bootstrap.Offcanvas.getOrCreateInstance(offcanvas).show();
    });
  });
</script>
<!-- üõí L√≥gica del carrito -->
<script src="carrito.js" defer></script>

</body>
</html>
